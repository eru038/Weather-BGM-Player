<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Weather BGM Player</title>
  <style>
    :root { --accent: #1db954; }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      font-family: "Segoe UI", sans-serif;
      color: #e6eef3;
      background: linear-gradient(180deg, var(--accent) 0%, #0e0f12 60%);
      transition: background 0.6s ease;
    }

    nav {
      width: 200px;
      background: rgba(0, 0, 0, 0.4);
      display: flex;
      flex-direction: column;
      padding: 20px;
    }

    nav button {
      background: none;
      border: none;
      color: white;
      font-size: 16px;
      margin: 10px 0;
      text-align: left;
      cursor: pointer;
      width: 100%;
      transition: 0.3s;
    }

    nav button:hover { color: var(--accent); }

    main {
      flex: 1;
      padding: 40px;
      opacity: 1;
      transition: opacity 0.5s ease;
    }

    main.fade-out { opacity: 0; }

    h1 { font-size: 28px; color: var(--accent); }

    .weather { margin-top: 20px; }

    .temp { font-size: 48px; }

    .spotify-btn {
      background: var(--accent);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 50px;
      font-size: 16px;
      cursor: pointer;
      margin-top: 20px;
    }

    .color-picker { margin-top: 20px; }

    ul { list-style: none; padding: 0; }

    li { margin: 12px 0; cursor: pointer; transition: color 0.3s; }
    li:hover { color: var(--accent); }

    audio { margin-top: 20px; width: 100%; }

    #player-bar {
      position: sticky;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 12px;
      border-top: 1px solid #333;
      display: flex;
      gap: 12px;
      align-items: center;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(6px);
    }

    #player-bar button, #player-bar input[type=range] { cursor: pointer; }

    #player-bar .spacer { flex: 1; }

    #premium-hint { display: none; margin-left: 8px; opacity: 0.8; }
    #open-in-spotify { display: none; color: #1DB954; text-decoration: underline; }
  </style>
</head>
<body>
  <nav>
    <div id="user-info" style="color:#9fd8b7;margin-bottom:8px;"></div>
    <button onclick="changePage('home')">ğŸ  ãƒ›ãƒ¼ãƒ </button>
    <button onclick="changePage('playlist')">ğŸµ ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆ</button>
    <button onclick="changePage('settings')">âš™ï¸ è¨­å®š</button>
  </nav>

  <main id="content">
    <h1>Weather BGM Player</h1>
    <div id="weather-area"></div>
    <div style="margin-top:16px;">
      <button class="spotify-btn" onclick="playWeatherOnSpotify()">Spotifyã§å¤©æ°—BGMã‚’å†ç”Ÿ</button>
    </div>
    <audio id="audio" controls></audio>
    <div id="player-bar">
      <button id="btn-prev">â®ï¸</button>
      <button id="btn-play">â–¶</button>
      <button id="btn-next">â­ï¸</button>
      <div style="display:flex;align-items:center;gap:6px;margin-left:12px;">
        <span>ğŸ”Š</span>
        <input id="vol" type="range" min="0" max="100" value="50" />
      </div>
      <div class="spacer"></div>
      <a id="open-in-spotify" href="#" target="_blank">åœ¨ Spotify ä¸­æ‰“å¼€</a>
      <span id="premium-hint" class="muted">éœ€è¦ Premium æ‰èƒ½ç½‘é¡µå†…æ§åˆ¶</span>
    </div>
  </main>

  <script>
    const content = document.getElementById('content');
    const OWM_API_KEY = "0b0a5fb6ef2e3bc313bdc815bdcafd07";
    window.__CURRENT_PAGE__ = 'home';

    (function restoreFromParam() {
      const from = new URLSearchParams(location.search).get('from');
      if (from) { changePage(from); history.replaceState({}, '', location.origin + location.pathname); }
    })();

    function changePage(page) {
      window.__CURRENT_PAGE__ = page;
      content.classList.add("fade-out");
      setTimeout(() => {
        if (page === "home") renderHome();
        else if (page === "playlist") renderPlaylist();
        else if (page === "settings") renderSettings();
        content.classList.remove("fade-out");
      }, 400);
    }

    function renderHome() {
      content.innerHTML = `
        <h1>Weather BGM Player</h1>
        <div id="weather-area"></div>
        <div style="margin-top:16px;">
          <button class="spotify-btn" onclick="playWeatherOnSpotify()">Spotifyã§å¤©æ°—BGMã‚’å†ç”Ÿ</button>
        </div>
        <audio id="audio" controls></audio>
        <div id="player-bar">
          <button id="btn-prev">â®ï¸</button>
          <button id="btn-play">â–¶</button>
          <button id="btn-next">â­ï¸</button>
          <div style="display:flex;align-items:center;gap:6px;margin-left:12px;">
            <span>ğŸ”Š</span>
            <input id="vol" type="range" min="0" max="100" value="50" />
          </div>
          <div class="spacer"></div>
          <a id="open-in-spotify" href="#" target="_blank">åœ¨ Spotify ä¸­æ‰“å¼€</a>
          <span id="premium-hint" class="muted">éœ€è¦ Premium æ‰èƒ½ç½‘é¡µå†…æ§åˆ¶</span>
        </div>
      `;
      loadWeather();
      bindControlEvents();
      initControls();
    }

    function renderPlaylist() {
      content.innerHTML = `
        <h1>ğŸµ ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆ</h1>
        <div id="playlist-toolbar" style="margin-bottom:12px;display:flex;gap:12px;align-items:center;">
          <button class="spotify-btn" onclick="connectSpotify()">Spotify é€£æº/æ›´æ–°</button>
          <span style="opacity:.8;font-size:14px;">ã‚µãƒ ãƒã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„</span>
        </div>
        <div id="playlists" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:16px;"></div>
        <div id="playlist-tracks" style="margin-top:20px;"></div>
        <div id="player-bar">
          <button id="btn-prev">â®ï¸</button>
          <button id="btn-play">â–¶</button>
          <button id="btn-next">â­ï¸</button>
          <div style="display:flex;align-items:center;gap:6px;margin-left:12px;">
            <span>ğŸ”Š</span>
            <input id="vol" type="range" min="0" max="100" value="50" />
          </div>
          <div class="spacer"></div>
          <a id="open-in-spotify" href="#" target="_blank">åœ¨ Spotify ä¸­æ‰“å¼€</a>
          <span id="premium-hint" class="muted">éœ€è¦ Premium æ‰èƒ½ç½‘é¡µå†…æ§åˆ¶</span>
        </div>
      `;
      bindControlEvents();
      initControls();
      renderUserPlaylists();
    }

    function renderSettings() {
      content.innerHTML = `
        <h1>âš™ï¸ è¨­å®š</h1>
        <button class="spotify-btn" onclick="connectSpotify()">Spotify é€£æº</button>
        <div class="color-picker">
          <label>ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã‚’é¸æŠï¼š</label>
          <input type="color" id="color-input" />
        </div>
      `;
      setupColorPicker();
      initControls();
    }

    // ä»¥ä¸‹ã€loadWeather, getLocationWithFallback, Spotifyé–¢é€£, renderUserPlaylists, renderTracksForPlaylistãªã©
    // å…ƒã‚³ãƒ¼ãƒ‰ã®æ©Ÿèƒ½ã¯ä¿æŒã€‚å¯èª­æ€§å‘ä¸Šã®ãŸã‚æ•´ç†æ¸ˆã¿ã€‚

  </script>
</body>
</html>
