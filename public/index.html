<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Weather BGM Player</title>
  <style>
    :root {
      --accent: #1db954;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      background: linear-gradient(180deg, var(--accent) 0%, #0e0f12 60%);
      color: #e6eef3;
      font-family: "Segoe UI", sans-serif;
      transition: background 0.6s ease;
    }

    nav {
      width: 200px;
      background: rgba(0, 0, 0, 0.4);
      display: flex;
      flex-direction: column;
      align-items: start;
      padding: 20px;
    }

    nav button {
      background: none;
      border: none;
      color: white;
      font-size: 16px;
      margin: 10px 0;
      text-align: left;
      cursor: pointer;
      width: 100%;
      transition: 0.3s;
    }

    nav button:hover {
      color: var(--accent);
    }

    main {
      flex: 1;
      padding: 40px;
      opacity: 1;
      transition: opacity 0.5s ease;
    }

    main.fade-out {
      opacity: 0;
    }

    h1 {
      font-size: 28px;
      color: var(--accent);
    }

    .weather {
      margin-top: 20px;
    }

    .temp {
      font-size: 48px;
    }

    .spotify-btn {
      background: var(--accent);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 50px;
      font-size: 16px;
      cursor: pointer;
      margin-top: 20px;
    }

    .color-picker {
      margin-top: 20px;
    }

    ul {
      list-style: none;
      padding: 0;
    }

    li {
      margin: 12px 0;
      cursor: pointer;
      transition: color 0.3s;
    }

    li:hover {
      color: var(--accent);
    }

    audio {
      margin-top: 20px;
      width: 100%;
    }

    #player-bar {
      position: sticky;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 12px;
      border-top: 1px solid #333;
      display: flex;
      gap: 12px;
      align-items: center;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(6px);
    }

    #player-bar button,
    #player-bar input[type=range] {
      cursor: pointer;
    }

    #player-bar .spacer {
      flex: 1;
    }

    #premium-hint {
      display: none;
      margin-left: 8px;
      opacity: .8;
    }

    #open-in-spotify {
      display: none;
      color: #1DB954;
      text-decoration: underline;
    }
  </style>
</head>

<body>
  <nav>
    <div id="user-info" style="color:#9fd8b7;margin-bottom:8px;"></div>
    <button onclick="changePage('home')">ğŸ  ãƒ›ãƒ¼ãƒ </button>
    <button onclick="changePage('playlist')">ğŸµ ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆ</button>
    <button onclick="changePage('settings')">âš™ï¸ è¨­å®š</button>
    <button id="login-btn" class="spotify-btn"></button>
  </nav>

  <main id="content">
    <h1>Weather BGM Player</h1>
    <div id="weather-area"></div>
    <div style="margin-top:16px;display:flex;flex-wrap:wrap;gap:12px;align-items:center;">
      <button class="spotify-btn" onclick="playWeatherOnSpotify()">å¤©æ°—ã«åˆã‚ã›ã¦Spotifyã§å†ç”Ÿ</button>
      <!-- ã“ã®ãƒœã‚¿ãƒ³ã¯åŸ‹ã‚è¾¼ã¿ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã™ã‚‹ã ã‘ã«å¤‰æ›´ -->
      <button class="spotify-btn" style="background:#2b8a3e;" onclick="playWeatherLocally()">ãƒ–ãƒ©ã‚¦ã‚¶ã§BGMå†ç”Ÿ</button>
    </div>
    <div id="weather-playlist" style="margin-top:24px;"></div>

    <!-- ä¸‹ã®ãƒãƒ¼ã¯å¾“æ¥é€šã‚Šï¼ˆSpotify Web Playback ç”¨ï¼‰ã€‚ãƒ­ãƒ¼ã‚«ãƒ«mp3ã«ã¯ä½¿ã‚ãªã„ -->
    <div id="player-bar">
      <button id="btn-prev">â®ï¸</button>
      <button id="btn-play">â–¶</button>
      <button id="btn-next">â­ï¸</button>
      <div id="current-track" class="muted"
        style="flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"></div>
      <div style="display:flex;align-items:center;gap:6px;margin-left:12px;">
        <span>ğŸ”Š</span>
        <input id="vol" type="range" min="0" max="100" value="50" />
      </div>
      <div class="spacer"></div>
      <a id="open-in-spotify" href="#" target="_blank">Spotifyã§ç¢ºèªã™ã‚‹</a>
      <span id="premium-hint" class="muted">PremiumãŒå¿…è¦</span>
    </div>
  </main>

  <script>
    const content = document.getElementById('content');
    const OWM_API_KEY = "0b0a5fb6ef2e3bc313bdc815bdcafd07";
    window.__CURRENT_PAGE__ = 'home'; // è®°å½•å½“å‰é¡µé¢

    // æ ¹æ® ?from=xxx å›åˆ°åŸé¡µé¢ï¼ˆæˆæƒå›è°ƒåè§¦å‘ï¼‰
    (function restoreFromParam() {
      const from = new URLSearchParams(location.search).get('from');
      if (from) {
        changePage(from);
        history.replaceState({}, '', location.origin + location.pathname);
      }
    })();

    function changePage(page) {
      window.__CURRENT_PAGE__ = page;
      content.classList.add("fade-out");
      setTimeout(() => {
        if (page === "home") {
          content.innerHTML = `
            <h1>Weather BGM Player</h1>
            <div id="weather-area"></div>
            <div style="margin-top:16px;">
              <button class="spotify-btn" onclick="playWeatherOnSpotify()">åœ¨ Spotify æ’­æ”¾ å¤©æ°—BGM</button>
            </div>
            <audio id="audio" controls></audio>
            <div id="player-bar">
              <button id="btn-prev">â®ï¸</button>
              <button id="btn-play">â–¶</button>
              <button id="btn-next">â­ï¸</button>
              <div style="display:flex;align-items:center;gap:6px;margin-left:12px;">
                <span>ğŸ”Š</span>
                <input id="vol" type="range" min="0" max="100" value="50" />
              </div>
              <div class="spacer"></div>
              <a id="open-in-spotify" href="#" target="_blank">åœ¨ Spotify ä¸­æ‰“å¼€</a>
              <span id="premium-hint" class="muted">éœ€è¦ Premium æ‰èƒ½ç½‘é¡µå†…æ§åˆ¶</span>
            </div>
          `;
          loadWeather(); bindControlEvents(); initControls();
        } else if (page === "playlist") {
          content.innerHTML = `
            <h1>ğŸµ ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆ</h1>
            <div id="playlist-toolbar" style="margin-bottom:12px;display:flex;gap:12px;align-items:center;">
              <button class="spotify-btn" onclick="connectSpotify()">Spotify é€£æº/æ›´æ–°</button>
              <span style="opacity:.8;font-size:14px;">ã‚µãƒ ãƒã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„</span>
            </div>
            <div id="playlists" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:16px;"></div>
            <div id="playlist-tracks" style="margin-top:20px;"></div>
            <div id="player-bar">
              <button id="btn-prev">â®ï¸</button>
              <button id="btn-play">â–¶</button>
              <button id="btn-next">â­ï¸</button>
              <div style="display:flex;align-items:center;gap:6px;margin-left:12px;">
                <span>ğŸ”Š</span>
                <input id="vol" type="range" min="0" max="100" value="50" />
              </div>
              <div class="spacer"></div>
              <a id="open-in-spotify" href="#" target="_blank">åœ¨ Spotify ä¸­æ‰“å¼€</a>
              <span id="premium-hint" class="muted">éœ€è¦ Premium æ‰èƒ½ç½‘é¡µå†…æ§åˆ¶</span>
            </div>
          `;
          bindControlEvents(); initControls();
          renderUserPlaylists();   // âœ… æ–°å¢ï¼šåŠ è½½å¹¶æ¸²æŸ“æ­Œå•
        } else if (page === "settings") {
          content.innerHTML = `
            <h1>âš™ï¸ è¨­å®š</h1>
            <button class="spotify-btn" onclick="connectSpotify()">Spotify é€£æº</button>
            <button class="spotify-btn" style="background:#e53935;margin-top:12px;" onclick="logoutSpotify()">Spotify ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            <div class="color-picker">
              <label>ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã‚’é¸æŠï¼š</label>
              <input type="color" id="color-input" />
            </div>
          `;
          setupColorPicker(); initControls(); // ä¿è¯æŒ‰é’®æ–‡æ¡ˆæ›´æ–°
        }
        content.classList.remove("fade-out");
      }, 400);
    }

    function playLocal(url) {
      const player = document.getElementById("audio");
      if (!player) return; player.src = url; player.play().catch(() => { });
    }

    function setupColorPicker() {
      const colorInput = document.getElementById('color-input');
      const savedAccent = localStorage.getItem('accentColor');
      if (savedAccent) {
        colorInput.value = savedAccent;
        document.documentElement.style.setProperty('--accent', savedAccent);
        document.body.style.background = `linear-gradient(180deg, ${savedAccent} 0%, #0e0f12 60%)`;
      }
      colorInput.addEventListener('input', () => {
        const newColor = colorInput.value;
        document.documentElement.style.setProperty('--accent', newColor);
        localStorage.setItem('accentColor', newColor);
        document.body.style.background = `linear-gradient(180deg, ${newColor} 0%, #0e0f12 60%)`;
      });
    }

    async function loadWeather() {
      const area = document.getElementById('weather-area');
      if (!area) return;

      try {
        // å®šä½ï¼ˆå¸¦å›é€€ï¼‰
        const loc = await getLocationWithFallback();
        const lat = loc.lat;
        const lon = loc.lon;
        const cityFromGeo = loc.city;

        // è¯·æ±‚ OWMï¼ˆå¢åŠ é”™è¯¯å¤„ç†ï¼‰
        const url = `https://api.openweathermap.org/data/2.5/weather?lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}&units=metric&lang=ja&appid=${encodeURIComponent(OWM_API_KEY)}`;
        const wRes = await fetch(url);

        if (!wRes.ok) {
          const txt = await wRes.text().catch(() => '');
          console.error('[weather] OWM not ok', wRes.status, txt);
          if (wRes.status === 401) {
            area.innerHTML = `<p>OpenWeatherMapã®APIã‚­ãƒ¼ãŒç„¡åŠ¹ã§ã™ï¼ˆ401ï¼‰ã€‚ã‚­ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>`;
          } else if (wRes.status === 429) {
            area.innerHTML = `<p>ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå¤šã™ãã¾ã™ï¼ˆ429ï¼‰ã€‚å°‘ã—å¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚</p>`;
          } else {
            area.innerHTML = `<p>å¤©æ°—æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆ${wRes.status}ï¼‰ã€‚</p>`;
          }
          return;
        }

        const wData = await wRes.json();

        // è§£æ
        const temp = Math.round(wData?.main?.temp ?? NaN);
        const weather = wData?.weather?.[0]?.description || 'â€”';
        const main = wData?.weather?.[0]?.main || 'Clouds';
        const city = cityFromGeo || wData?.name || 'â€”';

        // é€‰æ‹©ä¸»é¢˜è‰²/å›¾æ ‡
        let icon = "ğŸŒˆ"; let accent = "#1db954";
        switch (main) {
          case "Clear": icon = "â˜€ï¸"; accent = "#f7b733"; break;
          case "Clouds": icon = "â˜ï¸"; accent = "#5f9ea0"; break;
          case "Rain": icon = "ğŸŒ§ï¸"; accent = "#4a90e2"; break;
          case "Drizzle": icon = "ğŸŒ¦ï¸"; accent = "#6ec6ff"; break;
          case "Thunderstorm": icon = "â›ˆï¸"; accent = "#3b3b98"; break;
          case "Snow": icon = "â„ï¸"; accent = "#00bcd4"; break;
          case "Mist":
          case "Fog": icon = "ğŸŒ«ï¸"; accent = "#aab2bd"; break;
        }

        // ç”¨æˆ·è‡ªå®šä¹‰é¢œè‰²ä¼˜å…ˆ
        const savedAccent = localStorage.getItem('accentColor');
        const finalAccent = savedAccent || accent;
        document.documentElement.style.setProperty('--accent', finalAccent);
        document.body.style.background = `linear-gradient(180deg, ${finalAccent} 0%, #0e0f12 60%)`;

        // æ¸²æŸ“
        const tempHtml = isNaN(temp) ? 'â€”' : `${temp}Â°C`;
        area.innerHTML = `
          <div class="weather">
            <h3>${city} ã®å¤©æ°—</h3>
            <p>${icon} ${weather}</p>
            <div class="temp">${tempHtml}</div>
            <div style="margin-top:6px;opacity:.7;font-size:14px;">ãƒ‡ãƒ¼ã‚¿å…ƒ: ${loc.source === 'browser' ? 'ãƒ–ãƒ©ã‚¦ã‚¶ä½ç½®æƒ…å ±' : loc.source === 'ipapi' ? 'IPä½ç½®æƒ…å ±' : 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ'}</div>
          </div>
        `;

        // ç»™ Spotify æœç´¢ç”¨
        window.__WEATHER_MAIN__ = main;
        createWeatherPlaylistIframe(main);

      } catch (e) {
        console.error('[weather] error:', e);
        if (area) area.innerHTML = `<p>å¤©æ°—æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>`;
      }
    }

    window.onload = () => {
      const savedAccent = localStorage.getItem('accentColor');
      if (savedAccent) {
        document.documentElement.style.setProperty('--accent', savedAccent);
        document.body.style.background = `linear-gradient(180deg, ${savedAccent} 0%, #0e0f12 60%)`;
      }
      loadWeather(); loadBattery(); bindControlEvents(); initControls();
    };

    async function loadBattery() {
      try {
        const battery = await navigator.getBattery();
        const area = document.getElementById('weather-area'); if (!area) return;
        const updateBattery = () => {
          const level = Math.round(battery.level * 100);
          const charging = battery.charging ? "âš¡å……é›»ä¸­" : "";
          let icon = "ğŸ”‹";
          if (level <= 20) icon = "ğŸª«";
          else if (level <= 50) icon = "ğŸ”‹";
          else if (level <= 80) icon = "ğŸ”‹ğŸ”‹";
          else icon = "ğŸ”‹ğŸ”‹ğŸ”‹";
          const batteryInfo = document.getElementById("battery-info");
          const html = `${icon} ${level}% ${charging}`;
          if (batteryInfo) batteryInfo.innerHTML = html;
          else {
            const div = document.createElement("div");
            div.id = "battery-info"; div.style.marginTop = "10px"; div.style.fontSize = "18px";
            div.innerHTML = html;
            area.appendChild(div);
          }
        };
        updateBattery();
        battery.addEventListener('levelchange', updateBattery);
        battery.addEventListener('chargingchange', updateBattery);
      } catch (e) { console.error("Battery APIã‚¨ãƒ©ãƒ¼:", e); }
    }

    // ===== Spotify OAuth + Playback =====

    (function ensureSdk() {
      const s = document.createElement('script'); s.src = "https://sdk.scdn.co/spotify-player.js";
      document.head.appendChild(s);
    })();

    async function api(path, opts = {}) {
      const res = await fetch(path, { credentials: 'include', ...opts });
      if (!res.ok) throw new Error(path + ' ' + res.status);
      const ct = res.headers.get('content-type') || '';
      if (ct.includes('application/json')) return res.json();
      return res.text();
    }

    // æŠŠæ¥æºé¡µå¸¦ç»™ /login
    function connectSpotify() {
      const from = window.__CURRENT_PAGE__ || 'home';
      window.location.href = '/login?from=' + encodeURIComponent(from);
    }

    let spotifyPlayer = null, spotifyDeviceId = null, IS_PREMIUM = false, LAST_OPEN_URL = null;

    async function fetchAccessToken() { const r = await fetch('/token', { credentials: 'include' }); if (!r.ok) return null; const j = await r.json(); return j.access_token; }
    async function ensureLoggedIn() { try { const me = await api('/me'); IS_PREMIUM = (me.product === 'premium'); return true; } catch { return false; } }
    async function isPremiumUser() { return IS_PREMIUM; }
    function setLastOpenUrl(url) {
      LAST_OPEN_URL = url || null;
      const openLink = document.getElementById('open-in-spotify');
      const hint = document.getElementById('premium-hint');
      if (!openLink || !hint) return;
      if (IS_PREMIUM) { openLink.style.display = 'none'; hint.style.display = 'none'; }
      else { if (LAST_OPEN_URL) { openLink.style.display = 'inline'; openLink.href = LAST_OPEN_URL; } else openLink.style.display = 'none'; hint.style.display = 'inline'; }
    }
    function setControlsDisabled(disabled) { ['btn-prev', 'btn-play', 'btn-next', 'vol'].forEach(id => { const el = document.getElementById(id); if (el) el.disabled = disabled; }); }
    function bindControlEvents() {
      const btnPrev = document.getElementById('btn-prev'); const btnPlay = document.getElementById('btn-play'); const btnNext = document.getElementById('btn-next'); const vol = document.getElementById('vol');
      let isPaused = true;
      if (btnPrev) btnPrev.onclick = async () => { if (!IS_PREMIUM || !spotifyPlayer) return; try { await spotifyPlayer.previousTrack(); } catch (e) { } };
      if (btnPlay) btnPlay.onclick = async () => { if (!IS_PREMIUM || !spotifyPlayer) return; try { if (isPaused) await spotifyPlayer.resume(); else await spotifyPlayer.pause(); } catch (e) { } };
      if (btnNext) btnNext.onclick = async () => { if (!IS_PREMIUM || !spotifyPlayer) return; try { await spotifyPlayer.nextTrack(); } catch (e) { } };
      if (vol) vol.oninput = async (e) => { if (!IS_PREMIUM || !spotifyPlayer) return; const v = Math.max(0, Math.min(1, e.target.value / 100)); try { await spotifyPlayer.setVolume(v); } catch (e) { } };
      if (window.Spotify && spotifyPlayer) {
        spotifyPlayer.addListener('player_state_changed', state => {
          if (!state) return; isPaused = state.paused;
          if (btnPlay) btnPlay.textContent = isPaused ? 'â–¶' : 'â¸ï¸';
          if (vol && typeof state.device?.volume_percent === 'number') vol.value = state.device.volume_percent;
        });
      }
    }
    async function initControls() {
      const info = document.getElementById('user-info');
      const logged = await ensureLoggedIn();

      if (!logged) {
        if (info) info.textContent = '';
        setControlsDisabled(true);
        const a = document.getElementById('open-in-spotify'); const h = document.getElementById('premium-hint');
        if (a) a.style.display = 'none'; if (h) h.style.display = 'none';
        return;
      }

      // æ˜¾ç¤ºç”¨æˆ·å & è®¾ç½®é¡µæŒ‰é’®æ–‡æ¡ˆ
      try {
        const me = await api('/me');
        if (info) info.textContent = `ğŸ§ ${me.display_name || me.id}`;
        if (window.__CURRENT_PAGE__ === 'settings') {
          const btn = document.querySelector('.spotify-btn');
          if (btn) btn.textContent = `Spotify é€£æºæ¸ˆã¿ï¼ˆ${me.display_name || me.id}ï¼‰`;
        }
      } catch { }

      if (IS_PREMIUM) {
        setControlsDisabled(false);
        const a = document.getElementById('open-in-spotify'); const h = document.getElementById('premium-hint');
        if (a) a.style.display = 'none'; if (h) h.style.display = 'none';
      } else {
        setControlsDisabled(true);
        const h = document.getElementById('premium-hint'); if (h) h.style.display = 'inline';
        if (LAST_OPEN_URL) { const a = document.getElementById('open-in-spotify'); if (a) { a.style.display = 'inline'; a.href = LAST_OPEN_URL; } }
      }
    }

    window.onSpotifyWebPlaybackSDKReady = async () => {
      const token = await fetchAccessToken(); if (!token) return;
      spotifyPlayer = new Spotify.Player({
        name: 'Weather BGM (Web Player)',
        getOAuthToken: async cb => { const t = await fetchAccessToken(); if (t) cb(t); },
        volume: 0.5
      });
      spotifyPlayer.addListener('initialization_error', ({ message }) => console.error(message));
      spotifyPlayer.addListener('authentication_error', ({ message }) => console.error(message));
      spotifyPlayer.addListener('account_error', ({ message }) => console.error(message));
      spotifyPlayer.addListener('playback_error', ({ message }) => console.error(message));
      spotifyPlayer.addListener('ready', ({ device_id }) => { spotifyDeviceId = device_id; });
      spotifyPlayer.addListener('not_ready', ({ device_id }) => { });
      await spotifyPlayer.connect();
    };

    const WEATHER_TO_QUERY = {
      'Clear': ['summer vibes', 'sunny chill', 'city pop'],
      'Rain': ['rainy day jazz', 'lofi rain', 'ambient rain'],
      'Drizzle': ['rainy cafe', 'lofi rain'],
      'Thunderstorm': ['dark ambient', 'cinematic storm'],
      'Snow': ['cozy winter', 'winter jazz'],
      'Clouds': ['cloudy day indie', 'indie chill'],
      'Mist': ['ambient mist', 'dream pop'],
      'Fog': ['ambient fog', 'deep focus']
    };

    function getTimeBasedQuery() {
      const hour = new Date().getHours();
      if (hour >= 6 && hour < 12) return ['morning acoustic', 'coffee jazz'];
      if (hour >= 12 && hour < 18) return ['afternoon chill', 'city pop'];
      if (hour >= 18 && hour < 24) return ['evening lofi', 'night jazz'];
      return ['midnight ambient', 'deep focus'];
    }

    // æ—¢å­˜ã® WEATHER_TO_QUERY ã¨çµ„ã¿åˆã‚ã›
    async function pickSpotifyAndPlay(weatherMain) {
      const loggedIn = await ensureLoggedIn();
      if (!loggedIn) { return connectSpotify(); }
      const token = await fetchAccessToken(); if (!token) return;

      const weatherQueries = WEATHER_TO_QUERY[weatherMain] || WEATHER_TO_QUERY['Clouds'];
      const timeQueries = getTimeBasedQuery();
      const queries = [...weatherQueries, ...timeQueries];

      const q = encodeURIComponent(queries[0]);
      const res = await fetch('https://api.spotify.com/v1/search?type=playlist,track&limit=1&q=' + q, { headers: { Authorization: 'Bearer ' + token } });
      // ä»¥ä¸‹ã¯æ—¢å­˜å‡¦ç†ã¨åŒã˜
    }


    async function waitForDeviceReady(timeoutMs = 8000) {
      const start = Date.now();
      while (!spotifyDeviceId && (Date.now() - start) < timeoutMs) { await new Promise(r => setTimeout(r, 200)); }
      return Boolean(spotifyDeviceId);
    }
    async function ensureActiveDevice() {
      const hasDevice = await waitForDeviceReady();
      if (hasDevice) {
        await fetch('/transfer', { method: 'PUT', credentials: 'include', headers: { 'content-type': 'application/json' }, body: JSON.stringify({ device_id: spotifyDeviceId }) });
        return true;
      }
      try { const list = await api('/devices'); const active = list.devices?.find(d => d.is_active); if (active) return true; } catch { }
      alert('æ‰¾ä¸åˆ°æ´»è·ƒçš„ Spotify è®¾å¤‡ã€‚è¯·å…ˆåœ¨ Spotify å®¢æˆ·ç«¯/ç½‘é¡µéšä¾¿æ’­æ”¾ä¸€é¦–æ­Œï¼Œç„¶åå†ç‚¹æ’­æ”¾ã€‚');
      return false;
    }
    async function createWeatherPlaylistIframe(weatherMain) {
  const token = await fetchAccessToken();
  if (!token) return connectSpotify();

  // 1. å¤©æ°—ã«å¿œã˜ãŸæ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
  const queries = WEATHER_TO_QUERY[weatherMain] || WEATHER_TO_QUERY['Clouds'];
  const q = encodeURIComponent(queries[0]);

  // 2. æ›²ã‚’æ¤œç´¢
  const res = await fetch(
    `https://api.spotify.com/v1/search?type=track&limit=10&q=${q}`,
    { headers: { Authorization: 'Bearer ' + token } }
  );
  const data = await res.json();
  const tracks = data.tracks?.items || [];
  const uris = tracks.map(t => t.uri);

  // 3. ãƒ¦ãƒ¼ã‚¶ãƒ¼IDå–å¾—
  const me = await api('/me');

  // 4. ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä½œæˆ
  const plRes = await fetch(`https://api.spotify.com/v1/users/${me.id}/playlists`, {
    method: 'POST',
    headers: {
      Authorization: 'Bearer ' + token,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      name: `${weatherMain} Playlist`,
      description: `å¤©æ°—ã€Œ${weatherMain}ã€ã«åˆã‚ã›ã¦è‡ªå‹•ç”Ÿæˆã—ãŸãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆ`,
      public: false
    })
  });
  const playlist = await plRes.json();

  // 5. æ›²ã‚’è¿½åŠ 
  await fetch(`https://api.spotify.com/v1/playlists/${playlist.id}/tracks`, {
    method: 'POST',
    headers: {
      Authorization: 'Bearer ' + token,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ uris })
  });

  // 6. iframe åŸ‹ã‚è¾¼ã¿
  const embedUrl = playlist.external_urls.spotify.replace(
    "open.spotify.com/",
    "open.spotify.com/embed/"
  );
  const panel = document.getElementById("weather-playlist");
  panel.innerHTML = `
    <h3>${weatherMain} ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆ</h3>
    <iframe style="border-radius:12px" 
            src="${embedUrl}" 
            width="100%" height="380" frameborder="0" 
            allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" 
            loading="lazy"></iframe>
  `;
}


    async function playWeatherOnSpotify() {
      const main = window.__WEATHER_MAIN__ || 'Clouds'; await pickSpotifyAndPlay(main);
    }

    async function pickSpotifyAndPlay(weatherMain) {
      const loggedIn = await ensureLoggedIn();
      if (!loggedIn) { return connectSpotify(); }
      const token = await fetchAccessToken(); if (!token) return;

      const queries = WEATHER_TO_QUERY[weatherMain] || WEATHER_TO_QUERY['Clouds'];
      const q = encodeURIComponent(queries[0]);
      const res = await fetch('https://api.spotify.com/v1/search?type=playlist,track&limit=1&q=' + q, { headers: { Authorization: 'Bearer ' + token } });
      if (!res.ok) return;
      const data = await res.json();

      let contextUri = null, trackUri = null, openUrl = null;
      if (data.playlists?.items?.[0]) { const pl = data.playlists.items[0]; contextUri = pl.uri; openUrl = pl.external_urls?.spotify; }
      else if (data.tracks?.items?.[0]) { const t = data.tracks.items[0]; trackUri = t.uri; openUrl = t.external_urls?.spotify; }
      else { return; }

      setLastOpenUrl(openUrl);

      if (!(await isPremiumUser())) { if (openUrl) location.href = openUrl; return; }
      if (!(await ensureActiveDevice())) { if (openUrl) location.href = openUrl; return; }

      const body = contextUri ? { context_uri: contextUri } : { uris: [trackUri] };
      const playRes = await fetch('/play', { method: 'PUT', credentials: 'include', headers: { 'content-type': 'application/json' }, body: JSON.stringify(body) });
      if (!playRes.ok) { if (openUrl) location.href = openUrl; }
    }

    async function getLocationWithFallback() {
      // 1) å…ˆè¯•æµè§ˆå™¨å®šä½ï¼ˆåŠ  6 ç§’è¶…æ—¶ï¼‰
      const geoByBrowser = new Promise((resolve, reject) => {
        if (!navigator.geolocation) return reject(new Error('geolocation_unsupported'));
        const tid = setTimeout(() => reject(new Error('geolocation_timeout')), 6000);
        navigator.geolocation.getCurrentPosition(
          pos => {
            clearTimeout(tid); resolve({
              lat: pos.coords.latitude,
              lon: pos.coords.longitude,
              city: null,  // æµè§ˆå™¨å®šä½é€šå¸¸æ²¡åŸå¸‚å
              source: 'browser'
            });
          },
          err => { clearTimeout(tid); reject(err); },
          { enableHighAccuracy: false, timeout: 5000, maximumAge: 300000 }
        );
      });

      try {
        const r = await geoByBrowser;
        return r;
      } catch (e) {
        console.warn('[geo] browser failed:', e.message || e);
      }

      // 2) å†è¯• IP å®šä½ï¼ˆipapiï¼‰
      try {
        const resp = await fetch('https://ipapi.co/json/');
        if (resp.ok) {
          const j = await resp.json();
          if (j && j.latitude && j.longitude) {
            return { lat: j.latitude, lon: j.longitude, city: j.city || null, source: 'ipapi' };
          }
        } else {
          console.warn('[geo] ipapi status:', resp.status);
        }
      } catch (e) {
        console.warn('[geo] ipapi error:', e);
      }

      // 3) æœ€åå…œåº•ï¼ˆä¸œäº¬ï¼‰
      console.warn('[geo] fallback to default: Tokyo');
      return { lat: 35.681236, lon: 139.767125, city: 'æ±äº¬(ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)', source: 'default' };
    }

    // æ‹‰å–å¹¶æ¸²æŸ“ç”¨æˆ·æ­Œå•
    async function renderUserPlaylists() {
      const grid = document.getElementById('playlists');
      const tracksPanel = document.getElementById('playlist-tracks');
      if (!grid) return;

      grid.innerHTML = `<div style="opacity:.8;">èª­ã¿è¾¼ã¿ä¸­...</div>`;
      tracksPanel.innerHTML = '';

      // æœªç™»å½• â†’ æç¤ºè¿æº
      const logged = await ensureLoggedIn();
      if (!logged) {
        grid.innerHTML = `<div style="opacity:.8;">æœªé€£æºã§ã™ã€‚ã€ŒSpotify é€£æº/æ›´æ–°ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚</div>`;
        return;
      }

      try {
        const data = await api('/playlists');
        const items = data.items || [];
        if (!items.length) {
          grid.innerHTML = `<div style="opacity:.8;">æ­Œå˜ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</div>`;
          return;
        }

        grid.innerHTML = items.map(p => {
          const img = p.image ? `<img src="${p.image}" alt="" style="width:100%;height:180px;object-fit:cover;border-radius:12px;">` : `<div style="width:100%;height:180px;background:#222;border-radius:12px;display:flex;align-items:center;justify-content:center;opacity:.6;">No Image</div>`;
          return `
            <div class="pl-card" data-plid="${p.id}" data-uri="${p.uri}" data-ext="${p.external_url || ''}" style="background:rgba(0,0,0,.25);border:1px solid #222;border-radius:14px;padding:10px;">
              <div class="pl-cover" style="position:relative;cursor:pointer;">
                ${img}
                <button class="play-btn" title="æ’­æ”¾" style="position:absolute;right:8px;bottom:8px;border:none;border-radius:18px;padding:8px 12px;background:#1DB954;color:#fff;cursor:pointer;">â–¶</button>
              </div>
              <div style="margin-top:8px;font-weight:600;line-height:1.3;">${escapeHtml(p.name)}</div>
              <div style="opacity:.8;font-size:12px;margin-top:2px;">${p.tracks_total} æ›² â€¢ by ${escapeHtml(p.owner)}</div>
              <div style="display:flex;gap:8px;margin-top:8px;">
                <button class="open-btn" style="border:1px solid #333;background:transparent;color:#e6eef3;border-radius:8px;padding:6px 10px;cursor:pointer;">Spotifyã§è¦‹ã‚‹</button>
                <button class="tracks-btn" style="border:1px solid #333;background:transparent;color:#e6eef3;border-radius:8px;padding:6px 10px;cursor:pointer;">ãƒªã‚¹ãƒˆè©³ã—ãè¦‹ã‚‹</button>
              </div>
            </div>
          `;
        }).join('');

        // ç»‘å®šäº‹ä»¶ï¼šç‚¹å‡»å°é¢æˆ–æ’­æ”¾æŒ‰é’® â†’ æ’­æ”¾æ­Œå•
        grid.querySelectorAll('.pl-card').forEach(card => {
          const id = card.dataset.plid;
          const uri = card.dataset.uri;
          const ext = card.dataset.ext;

          // æ’­æ”¾
          card.querySelector('.pl-cover').addEventListener('click', () => {
            playSpotifyPlaylist({ id, uri, external_url: ext });
          });
          card.querySelector('.play-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            playSpotifyPlaylist({ id, uri, external_url: ext });
          });

          // åœ¨ Spotify æ‰“å¼€
          card.querySelector('.open-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            if (ext) window.open(ext, '_blank');
          });

          // å±•å¼€æ›²ç›®
          card.querySelector('.tracks-btn').addEventListener('click', async (e) => {
            e.stopPropagation();
            await renderTracksForPlaylist(id, card, tracksPanel);
          });
        });

      } catch (e) {
        console.error('renderUserPlaylists error', e);
        grid.innerHTML = `<div style="opacity:.8;">æ­Œå˜ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</div>`;
      }
    }

    // Premium â†’ ç½‘é¡µå†…ç›´æ¥æ’­æ”¾ï¼›éä¼šå‘˜ â†’ è·³åˆ° Spotify
    async function playSpotifyPlaylist(playlist) {
      setLastOpenUrl(playlist.external_url || null);

      const logged = await ensureLoggedIn();
      if (!logged) return connectSpotify();

      if (!(await isPremiumUser())) {
        if (playlist.external_url) location.href = playlist.external_url;
        return;
      }

      // Premiumï¼šç¡®ä¿è®¾å¤‡ï¼Œå°±åœ°æ’­æ”¾
      const ok = await ensureActiveDevice();
      if (!ok) {
        if (playlist.external_url) location.href = playlist.external_url;
        return;
      }

      try {
        const res = await fetch('/play', {
          method: 'PUT',
          credentials: 'include',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify({ context_uri: playlist.uri })
        });
        if (!res.ok && playlist.external_url) {
          location.href = playlist.external_url;
        }
      } catch (e) {
        console.error('play playlist error', e);
        if (playlist.external_url) location.href = playlist.external_url;
      }
    }

    // å±•å¼€æ˜¾ç¤ºæ­Œå•æ›²ç›®ï¼ˆåªå–å‰ 100 é¦–ï¼‰
    async function renderTracksForPlaylist(playlistId, cardEl, panelEl) {
      if (!panelEl) return;
      panelEl.innerHTML = `<div style="opacity:.8;">æ›²ç›®èª­ã¿è¾¼ã¿ä¸­...</div>`;
      try {
        const data = await api(`/playlist/${encodeURIComponent(playlistId)}/tracks?limit=100`);
        const items = data.items || [];
        if (!items.length) {
          panelEl.innerHTML = `<div style="opacity:.8;">æ›²ç›®ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
          return;
        }
        panelEl.innerHTML = `
          <h3 style="margin-top:12px;">æ›²ç›®ï¼ˆå‰ ${items.length} é¦–ï¼‰</h3>
          <div style="display:grid;grid-template-columns:1fr;gap:10px;margin-top:8px;">
            ${items.map((t, i) => `
              <div style="display:flex;gap:10px;align-items:center;background:rgba(0,0,0,.25);border:1px solid #222;border-radius:10px;padding:8px;">
                <div style="width:40px;text-align:right;opacity:.7;">${i + 1}</div>
                ${t.image ? `<img src="${t.image}" style="width:40px;height:40px;object-fit:cover;border-radius:6px;">` : `<div style="width:40px;height:40px;background:#222;border-radius:6px;"></div>`}
                <div style="flex:1;min-width:0;">
                  <div style="font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${escapeHtml(t.name)}</div>
                  <div style="opacity:.8;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${escapeHtml((t.artists || []).join(', '))}</div>
                </div>
                <button onclick="openTrackExternally('${t.external_url || ''}')" style="border:1px solid #333;background:transparent;color:#e6eef3;border-radius:8px;padding:6px 10px;cursor:pointer;">æ‰“å¼€</button>
              </div>
            `).join('')}
          </div>
        `;
      } catch (e) {
        console.error('renderTracksForPlaylist error', e);
        panelEl.innerHTML = `<div style="opacity:.8;">æ›²ç›®ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</div>`;
      }
    }

    function openTrackExternally(url) {
      if (!url) return;
      window.open(url, '_blank');
    }

    function escapeHtml(s) {
      return (s || '').replace(/[&<>"]/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;' }[c]));
    }
    async function logoutSpotify() {
      try {
        await fetch('/logout', { method: 'POST', credentials: 'include' });
        localStorage.removeItem('spotify_access_token');
        localStorage.removeItem('spotify_refresh_token');

        const logoutUrl = 'https://accounts.spotify.com/logout?continue='
          + encodeURIComponent(window.location.origin + '/login.html');
        window.location.href = logoutUrl;
      } catch (err) {
        console.error('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå¤±æ•—:', err);
      }
    }

    async function updateNavLoginButton() {
      const loginBtn = document.getElementById('login-btn');
      try {
        // ã‚µãƒ¼ãƒãƒ¼ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚‹ã‹ç¢ºèª
        const res = await fetch('/token', { credentials: 'include' });
        if (res.ok) {
          loginBtn.textContent = 'Spotify ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ';
          loginBtn.style.background = '#e53935';
          loginBtn.onclick = logoutSpotify;
        } else {
          loginBtn.textContent = 'Spotify ãƒ­ã‚°ã‚¤ãƒ³';
          loginBtn.style.background = '#1db954';
          loginBtn.onclick = () => { window.location.href = '/login'; };
        }
      } catch (err) {
        console.error(err);
        loginBtn.textContent = 'Spotify ãƒ­ã‚°ã‚¤ãƒ³';
        loginBtn.style.background = '#1db954';
        loginBtn.onclick = () => { window.location.href = '/login'; };
      }
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«æ›´æ–°
    updateNavLoginButton();


  </script>
</body>

</html>
