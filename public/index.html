<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Weather BGM Player</title>
  <style>
    :root { --accent: #1db954; }
    body {
      margin: 0; min-height: 100vh; display: flex;
      background: linear-gradient(180deg, var(--accent) 0%, #0e0f12 60%);
      color: #e6eef3; font-family: "Segoe UI", sans-serif; transition: background 0.6s ease;
    }
        /* â˜…å¤©æ°—ã‚¢ãƒ‹ãƒ¡ç”¨ã‚­ãƒ£ãƒ³ãƒã‚¹ï¼ˆç”»é¢å…¨ä½“ã«å›ºå®šè¡¨ç¤ºï¼‰ */
    #weather-animation {
      position: fixed;
      inset: 0;              /* top:0;right:0;bottom:0;left:0 ã¨åŒã˜ */
      pointer-events: none;  /* ã‚¯ãƒªãƒƒã‚¯ãªã©ã‚’é‚ªé­”ã—ãªã„ */
      z-index: 0;            /* ä¸€ç•ªå¾Œã‚å´ */
    }

    /* nav ã¨ main ãŒã‚¢ãƒ‹ãƒ¡ã®ä¸Šã«æ¥ã‚‹ã‚ˆã†ã« */
    nav, main {
      position: relative;
      z-index: 1;
    }
    nav { width: 200px; background: rgba(0, 0, 0, 0.4); display: flex; flex-direction: column; align-items: start; padding: 20px; }
    nav button { background: none; border: none; color: white; font-size: 16px; margin: 10px 0; text-align: left; cursor: pointer; width: 100%; transition: 0.3s; }
    nav button:hover { color: var(--accent); }
    main { flex: 1; padding: 40px; opacity: 1; transition: opacity 0.5s ease; }
    main.fade-out { opacity: 0; }
    h1 { font-size: 28px; color: var(--accent); }
    .weather { margin-top: 20px; }
    .temp { font-size: 48px; }
    .spotify-btn { background: var(--accent); color: white; border: none; padding: 12px 24px; border-radius: 50px; font-size: 16px; cursor: pointer; margin-top: 20px; }
    .playlist-card { background: rgba(0, 0, 0, 0.25); border: 1px solid #222; border-radius: 12px; padding: 12px 16px; margin-top: 14px; }
    .playlist-card h4 { margin: 0; font-size: 18px; color: #f5f8fa; }
    .playlist-card p { margin: 4px 0 12px; opacity: .75; font-size: 14px; }
    .muted { opacity: .65; }
    .color-picker { margin-top: 20px; }
    ul { list-style: none; padding: 0; }
    li { margin: 12px 0; cursor: pointer; transition: color 0.3s; }
    li:hover { color: var(--accent); }
    audio { margin-top: 20px; width: 100%; }
    #player-bar{position:sticky;bottom:0;left:0;right:0;padding:12px;border-top:1px solid #333;display:flex;gap:12px;align-items:center;background:rgba(0,0,0,0.6);backdrop-filter:blur(6px);}
    #player-bar button,#player-bar input[type=range]{cursor:pointer;}
    #player-bar .spacer{flex:1;}
    #premium-hint{display:none;margin-left:8px;opacity:.8;}
    #open-in-spotify{display:none;color:#1DB954;text-decoration:underline;}
  </style>
</head>
<body>
  <!-- â˜…å¤©æ°—ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®ã‚­ãƒ£ãƒ³ãƒã‚¹ -->
  <canvas id="weather-animation"></canvas>
  <nav>
    <div id="user-info" style="color:#9fd8b7;margin-bottom:8px;"></div>
    <button onclick="changePage('home')">ğŸ  ãƒ›ãƒ¼ãƒ </button>
    <button onclick="changePage('playlist')">ğŸµ ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆ</button>
    <button onclick="changePage('settings')">âš™ï¸ è¨­å®š</button>
    <button id="login-btn" class="spotify-btn">Spotify ãƒ­ã‚°ã‚¤ãƒ³</button>
  </nav>

  <main id="content">
    <h1>Weather BGM Player</h1>
    <div id="weather-area"></div>
    <div style="margin-top:16px;display:flex;flex-wrap:wrap;gap:12px;align-items:center;">
      <button class="spotify-btn" onclick="playWeatherOnSpotify()">å¤©æ°—ã«åˆã‚ã›ã¦Spotifyã§å†ç”Ÿ</button>
      <!-- ã“ã®ãƒœã‚¿ãƒ³ã¯åŸ‹ã‚è¾¼ã¿ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã™ã‚‹ã ã‘ã«å¤‰æ›´ -->
      <button class="spotify-btn" style="background:#2b8a3e;" onclick="playWeatherLocally()">ãƒ–ãƒ©ã‚¦ã‚¶ã§BGMå†ç”Ÿ</button>
    </div>
    <div id="weather-playlist" style="margin-top:24px;"></div>
    <div id="weather-player" style="margin-top:24px;"></div>

    
  </main>

  <script>
    let currentUserId = null;
    const content = document.getElementById('content');
    const OWM_API_KEY = "677857b64fb220eca86422d22aa48502";
    window.__CURRENT_PAGE__ = 'home'; 

    // â–  å¤©æ°—ã”ã¨ã® Spotify åŸ‹ã‚è¾¼ã¿ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆ ID
    // ã€€â€»ã“ã“ã‚’è‡ªåˆ†ã®ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆIDã«å·®ã—æ›¿ãˆã¦OK
    const WEATHER_SPOTIFY_EMBEDS = {
      Clear:   "37i9dQZF1DX1BzILRveYHb",
      Clouds:  "70z8IFIsiDbuhqk31PEzg2",
      Rain:    "7M0eY74HWuqEeDG025oX2y",
      Drizzle: "6gT9NAs3rsCNnpojsDEJnI",
      Thunderstorm: "6GSL0FPKhtJusmtdOf4X5e",
      Snow:    "4qAwf4rc4qV1ip9QWM4V0q",
      Mist:    "37i9dQZF1DWZqNqPemiefM",
      Fog:     "6lWhmAjP6PEvLTscLQ5qkS",
      Haze:    "6sYhyOpqzC9KHwtCWOpeli",
      Smoke:   "5DAU4ZGG3uZ5RgsK8q5JdZ",
      Default: "37i9dQZF1E37tmQy7dPy4B"
    };

    const LOCAL_VOLUME_KEY = 'localBgmVolume';

    (function restoreFromParam(){
      const from = new URLSearchParams(location.search).get('from');
      if (from) {
        changePage(from);
        history.replaceState({}, '', location.origin + location.pathname);
      }
    })();

    function changePage(page) {
      window.__CURRENT_PAGE__ = page;
      content.classList.add("fade-out");
      setTimeout(() => {
        if (page === "home") {
          content.innerHTML = `
            <h1>Weather BGM Player</h1>
            <div id="weather-area"></div>
            <div style="margin-top:16px;">
              <button class="spotify-btn" onclick="playWeatherOnSpotify()">åœ¨ Spotify æ’­æ”¾ å¤©æ°—BGM</button>
            </div>
            
            <div id="weather-playlist" style="margin-top:24px;"></div>
            
          `;
          loadWeather(); 
        } else if (page === "playlist") {
          content.innerHTML = `
            <h1>ğŸµ ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆ</h1>
            <div id="playlist-toolbar" style="margin-bottom:12px;display:flex;gap:12px;align-items:center;">
              <button class="spotify-btn" onclick="connectSpotify()">Spotify é€£æº/æ›´æ–°</button>
              <span style="opacity:.8;font-size:14px;">ã‚µãƒ ãƒã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„</span>
            </div>
            <div id="playlists" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:16px;"></div>
            <div id="playlist-tracks" style="margin-top:20px;"></div>
            
          `;
          bindControlEvents(); initControls();
          renderUserPlaylists();   
        } else if (page === "settings") {
          content.innerHTML = `
            <h1>âš™ï¸ è¨­å®š</h1>
            <button class="spotify-btn" onclick="connectSpotify()">Spotify é€£æº</button>
            <button class="spotify-btn" style="background:#e53935;margin-top:12px;" onclick="logoutSpotify()">Spotify ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            <div class="color-picker">
              <label>ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã‚’é¸æŠï¼š</label>
              <input type="color" id="color-input" />
            </div>
          `;
          setupColorPicker(); initControls();
        }
        content.classList.remove("fade-out");
      }, 400);
    }

    function resolveWeatherKey(main) {
      // å…ƒã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’æµç”¨
      if (WEATHER_SPOTIFY_EMBEDS[main]) return main;
      if (['Mist', 'Fog', 'Haze', 'Smoke'].includes(main) && WEATHER_SPOTIFY_EMBEDS['Mist']) return 'Mist';
      return 'Default';
    }

    function updateCurrentTrackLabel(text) {
      const label = document.getElementById('current-track');
      if (!label) return;
      label.textContent = text || '';
    }

    // â˜…ã“ã“ã‚’ã€Œè‡ªä½œBGMãƒªã‚¹ãƒˆã€â†’ã€ŒSpotifyåŸ‹ã‚è¾¼ã¿ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼è¡¨ç¤ºã€ã«å¤‰æ›´
    function renderWeatherPlaylist(main) {
      const container = document.getElementById('weather-playlist');
      if (!container) return;

      const key = resolveWeatherKey(main || 'Default');
      const playlistId = WEATHER_SPOTIFY_EMBEDS[key] || WEATHER_SPOTIFY_EMBEDS['Default'];
      if (!playlistId) {
        container.innerHTML = `<div class="muted">ã“ã®å¤©æ°—ã®ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</div>`;
        return;
      }

      const src = `https://open.spotify.com/embed/playlist/${encodeURIComponent(playlistId)}?utm_source=generator`;

      container.innerHTML = `
        <div class="playlist-card">
          <h4>å¤©æ°—ã«åˆã‚ã›ãŸSpotifyãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆ</h4>
          <p class="muted" style="font-size:14px;margin-bottom:12px;">
            ä¸‹ã®Spotifyãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‹ã‚‰ç›´æ¥å†ç”Ÿã§ãã¾ã™ã€‚
          </p>
          <iframe
            id="playlist-frame"
            style="border-radius:12px"
            src="${src}"
            width="100%"
            height="352"
            frameborder="0"
            allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
            loading="lazy">
          </iframe>
        </div>
      `;

      updateCurrentTrackLabel(`Spotifyãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆï¼ˆ${key}ï¼‰`);
    }

    function ensureLocalVolume(player, slider) {
      if (!player) return;
      let volume = 0.5;
      const saved = parseFloat(localStorage.getItem(LOCAL_VOLUME_KEY));
      if (Number.isFinite(saved) && saved >= 0 && saved <= 1) volume = saved;

      player.volume = volume;
      if (slider) slider.value = Math.round(volume * 100);
    }

    function setupColorPicker() {
      const colorInput = document.getElementById('color-input');
      const savedAccent = localStorage.getItem('accentColor');
      if (savedAccent) {
        colorInput.value = savedAccent;
        document.documentElement.style.setProperty('--accent', savedAccent);
        document.body.style.background = `linear-gradient(180deg, ${savedAccent} 0%, #0e0f12 60%)`;
      }
      colorInput.addEventListener('input', () => {
        const newColor = colorInput.value;
        document.documentElement.style.setProperty('--accent', newColor);
        localStorage.setItem('accentColor', newColor);
        document.body.style.background = `linear-gradient(180deg, ${newColor} 0%, #0e0f12 60%)`;
      });
    }
function mapWeather(main) {
  if (main === "Clear") {
    return { label: "æ™´ã‚Œ", key: "sunny", icon: "â˜€ï¸", accent: "#f7b733" };
  }
  if (main === "Clouds") {
    return { label: "ãã‚‚ã‚Š", key: "cloudy", icon: "â˜ï¸", accent: "#5f9ea0" };
  }
  if (main === "Rain" || main === "Drizzle") {
    return { label: "é›¨", key: "rainy", icon: "ğŸŒ§ï¸", accent: "#4a90e2" };
  }
  if (main === "Snow") {
    return { label: "é›ª", key: "snowy", icon: "â„ï¸", accent: "#00bcd4" };
  }
  if (main === "Thunderstorm") {
    return { label: "é›·é›¨", key: "rainy", icon: "â›ˆï¸", accent: "#3b3b98" };
  }
  if (main === "Mist" || main === "Fog") {
    return { label: "éœ§", key: "cloudy", icon: "ğŸŒ«ï¸", accent: "#aab2bd" };
  }

  return { label: "å¤©æ°—", key: "default", icon: "ğŸŒˆ", accent: "#1db954" };
}

    async function loadWeather() {
      const area = document.getElementById('weather-area');
      if (!area) return;
      let used = false;
      try {
        const loc = await getLocationWithFallback();
        const lat = loc.lat;
        const lon = loc.lon;
        const cityFromGeo = loc.city;

        const url = `https://api.openweathermap.org/data/2.5/weather?lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}&units=metric&lang=ja&appid=${encodeURIComponent(OWM_API_KEY)}`;
        const wRes = await fetch(url);

        if (!wRes.ok) {
          const txt = await wRes.text().catch(() => '');
          console.error('[weather] OWM not ok', wRes.status, txt);
          if (wRes.status === 401) {
            area.innerHTML = `<p>OpenWeatherMapã®APIã‚­ãƒ¼ãŒç„¡åŠ¹ã§ã™ï¼ˆ401ï¼‰ã€‚ã‚­ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>`;
          } else if (wRes.status === 429) {
            area.innerHTML = `<p>ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå¤šã™ãã¾ã™ï¼ˆ429ï¼‰ã€‚å°‘ã—å¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚</p>`;
          } else {
            area.innerHTML = `<p>å¤©æ°—æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆ${wRes.status}ï¼‰ã€‚</p>`;
          }
          return;
        }

      const wData = await wRes.json();

const t = Math.round(wData?.main?.temp ?? NaN);
const main = wData?.weather?.[0]?.main || "Clouds";
const city = cityFromGeo || wData?.name || "â€”";

const w = mapWeather(main);

const saved = localStorage.getItem("accentColor");
const finalAccent = saved || w.accent;

document.documentElement.style.setProperty("--accent", finalAccent);
document.body.style.background =
  `linear-gradient(180deg, ${finalAccent} 0%, #0e0f12 60%)`;

const tempHtml = isNaN(t) ? "â€”" : `${t}Â°C`;

area.innerHTML = `
  <div class="weather">
    <h3>${city} ã®å¤©æ°—</h3>
    <p>${w.icon} ${w.label}</p>
    <div class="temp">${tempHtml}</div>
    <div style="margin-top:6px;opacity:.7;font-size:14px;">
      ãƒ‡ãƒ¼ã‚¿å…ƒ: ${
        loc.source === "browser" ? "ãƒ–ãƒ©ã‚¦ã‚¶ä½ç½®æƒ…å ±"
        : loc.source === "ipapi" ? "IPä½ç½®æƒ…å ±"
        : "ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ"
      }
    </div>
  </div>
`;

// â˜… ã“ã“ãŒé‡è¦ï¼šDB â†’ fallback ã®é †


        used = await renderWeatherPlaylistFromDB(main);
        if (!used) {
          renderWeatherPlaylist(main);
        }
        
        setWeatherAnimation(main);

      } catch (e) {
        console.error('[weather] error:', e);
        if (area) area.innerHTML = `<p>å¤©æ°—æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>`;
        window.__WEATHER_MAIN__ = 'Default';
        
        used = await renderWeatherPlaylistFromDB('Default');
        if (!used) {
          renderWeatherPlaylist('Default');
        }
        
        setWeatherAnimation('Default');
      }
    }

    window.onload = () => {
      const savedAccent = localStorage.getItem('accentColor');
      if (savedAccent) {
        document.documentElement.style.setProperty('--accent', savedAccent);
        document.body.style.background = `linear-gradient(180deg, ${savedAccent} 0%, #0e0f12 60%)`;
      }
      setWeatherAnimation('Default');
      loadWeather();
      bindControlEvents();
      initControls();
      
      const loginBtn = document.getElementById('login-btn');
      if (loginBtn) {
        loginBtn.onclick = connectSpotify;
      }
    };

    

    // ===== Spotify OAuth + Playback =====

    (function ensureSdk(){
      const s = document.createElement('script'); s.src = "https://sdk.scdn.co/spotify-player.js";
      document.head.appendChild(s);
    })();

    async function api(path, opts={}){
      const res = await fetch(path, {credentials:'include', ...opts});
      if(!res.ok) throw new Error(path+' '+res.status);
      const ct = res.headers.get('content-type')||'';
      if(ct.includes('application/json')) return res.json();
      return res.text();
    }

    function connectSpotify(){
      const from = window.__CURRENT_PAGE__ || 'home';
      window.location.href = '/login?from=' + encodeURIComponent(from);
    }

    let spotifyPlayer = null, spotifyDeviceId = null, IS_PREMIUM = false, LAST_OPEN_URL = null;

    async function fetchAccessToken(){ const r = await fetch('/token', {credentials:'include'}); if(!r.ok) return null; const j = await r.json(); return j.access_token; }
    async function ensureLoggedIn() {
      try {
        const me = await api('/me');
    
        currentUserId = me.id;
        IS_PREMIUM = (me.product === 'premium');
    
        console.log("login user:", currentUserId, "premium:", IS_PREMIUM);
    
        return true;
      } catch (e) {
        console.warn("not logged in", e);
        currentUserId = null;
        IS_PREMIUM = false;
        return false;
      }
    }

    async function isPremiumUser(){ return IS_PREMIUM; }
    function setLastOpenUrl(url){
      LAST_OPEN_URL = url || null;
      const openLink = document.getElementById('open-in-spotify');
      const hint = document.getElementById('premium-hint');
      if(!openLink || !hint) return;
      if(IS_PREMIUM){ openLink.style.display = 'none'; hint.style.display = 'none'; }
      else { if (LAST_OPEN_URL){ openLink.style.display = 'inline'; openLink.href = LAST_OPEN_URL; } else openLink.style.display = 'none'; hint.style.display = 'inline'; }
    }
    function setControlsDisabled(disabled){ ['btn-prev','btn-play','btn-next','vol'].forEach(id=>{ const el=document.getElementById(id); if (el) el.disabled = disabled; }); }
    function bindControlEvents(){
      const btnPrev=document.getElementById('btn-prev'); const btnPlay=document.getElementById('btn-play'); const btnNext=document.getElementById('btn-next'); const vol=document.getElementById('vol');
      let isPaused = true;

      if (btnPrev) btnPrev.onclick = async ()=>{
        if (IS_PREMIUM && spotifyPlayer){ try { await spotifyPlayer.previousTrack(); } catch(e){} }
      };

      if (btnPlay) btnPlay.onclick = async ()=>{
        if (IS_PREMIUM && spotifyPlayer){
          try { if (isPaused) await spotifyPlayer.resume(); else await spotifyPlayer.pause(); }
          catch(e){}
        } else {
          // åŸ‹ã‚è¾¼ã¿ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ©ç”¨æ™‚ã¯ã“ã“ã§ã¯ä½•ã‚‚ã—ãªã„
        }
      };

      if (btnNext) btnNext.onclick = async ()=>{
        if (IS_PREMIUM && spotifyPlayer){ try { await spotifyPlayer.nextTrack(); } catch(e){} }
      };

      if (vol) vol.oninput = async (e)=>{
        const v=Math.max(0,Math.min(1,e.target.value/100));
        if (IS_PREMIUM && spotifyPlayer){
          try { await spotifyPlayer.setVolume(v); }
          catch(e){}
        }
      };

      if (window.Spotify && spotifyPlayer) {
        spotifyPlayer.addListener('player_state_changed', state => {
          if (!state) return; isPaused = state.paused;
          const btn = document.getElementById('btn-play');
          if (btn) btn.textContent = state.paused ? 'â–¶' : 'â¸ï¸';
          if (vol && typeof state.device?.volume_percent === 'number') vol.value = state.device.volume_percent;
        });
      }
    }
    async function initControls(){
      const info = document.getElementById('user-info');
      const logged = await ensureLoggedIn();

      if (!logged){
        if (info) info.textContent = '';
        setControlsDisabled(false);
        const a=document.getElementById('open-in-spotify'); const h=document.getElementById('premium-hint');
        if(a) a.style.display='none'; if(h) h.style.display='none';
        return;
      }

      try{
        const me = await api('/me');
        if (info) info.textContent = `ğŸ§ ${me.display_name || me.id}`;
        if (window.__CURRENT_PAGE__ === 'settings') {
          const btn = document.querySelector('.spotify-btn');
          if (btn) btn.textContent = `Spotify é€£æºæ¸ˆã¿ï¼ˆ${me.display_name || me.id}ï¼‰`;
        }
      }catch{}

      if (IS_PREMIUM){
        setControlsDisabled(false);
        const a=document.getElementById('open-in-spotify'); const h=document.getElementById('premium-hint');
        if(a) a.style.display='none'; if(h) h.style.display='none';
      }else{
        setControlsDisabled(false);
        const h=document.getElementById('premium-hint'); if(h) h.style.display='inline';
        if (LAST_OPEN_URL){ const a=document.getElementById('open-in-spotify'); if(a){ a.style.display='inline'; a.href=LAST_OPEN_URL; } }
      }
    }

    window.onSpotifyWebPlaybackSDKReady = async () => {
      const token = await fetchAccessToken(); if(!token) return;
      spotifyPlayer = new Spotify.Player({
        name: 'Weather BGM (Web Player)',
        getOAuthToken: async cb => { const t = await fetchAccessToken(); if (t) cb(t); },
        volume: 0.5
      });
      spotifyPlayer.addListener('initialization_error', ({ message }) => console.error(message));
      spotifyPlayer.addListener('authentication_error', ({ message }) => console.error(message));
      spotifyPlayer.addListener('account_error', ({ message }) => console.error(message));
      spotifyPlayer.addListener('playback_error', ({ message }) => console.error(message));
      spotifyPlayer.addListener('ready', ({ device_id }) => { spotifyDeviceId = device_id; });
      spotifyPlayer.addListener('not_ready', ({ device_id }) => {});
      await spotifyPlayer.connect();
    };

    const WEATHER_TO_QUERY = {
      'Clear': ['summer vibes', 'sunny chill', 'city pop'],
      'Rain': ['rainy day jazz', 'lofi rain', 'ambient rain'],
      'Drizzle': ['rainy cafe', 'lofi rain'],
      'Thunderstorm': ['dark ambient', 'cinematic storm'],
      'Snow': ['cozy winter', 'winter jazz'],
      'Clouds': ['cloudy day indie', 'indie chill'],
      'Mist': ['ambient mist', 'dream pop'],
      'Fog': ['ambient fog', 'deep focus']
    };

    async function waitForDeviceReady(timeoutMs = 8000) {
      const start = Date.now();
      while (!spotifyDeviceId && (Date.now() - start) < timeoutMs) { await new Promise(r => setTimeout(r, 200)); }
      return Boolean(spotifyDeviceId);
    }
    async function ensureActiveDevice() {
      const hasDevice = await waitForDeviceReady();
      if (hasDevice) {
        await fetch('/transfer', { method:'PUT', credentials:'include', headers:{'content-type':'application/json'}, body: JSON.stringify({device_id: spotifyDeviceId}) });
        return true;
      }
      try { const list = await api('/devices'); const active = list.devices?.find(d => d.is_active); if (active) return true; }catch{}
      alert('Spotifyãƒ‡ãƒã‚¤ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
      return false;
    }

    async function playWeatherOnSpotify(){
      const main = window.__WEATHER_MAIN__ || 'Clouds'; await pickSpotifyAndPlay(main);
    }

    // ã€Œãƒ–ãƒ©ã‚¦ã‚¶ã§BGMå†ç”Ÿã€= åŸ‹ã‚è¾¼ã¿ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
    function playWeatherLocally() {
      const el = document.getElementById('weather-playlist');
      if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    async function pickSpotifyAndPlay(weatherMain){
      const loggedIn = await ensureLoggedIn();
      if(!loggedIn){ return connectSpotify(); }
      const token = await fetchAccessToken(); if(!token) return;

      const queries = WEATHER_TO_QUERY[weatherMain] || WEATHER_TO_QUERY['Clouds'];
      const q = encodeURIComponent(queries[0]);
      const res = await fetch('https://api.spotify.com/v1/search?type=playlist,track&limit=1&q='+q, { headers: { Authorization: 'Bearer '+token } });
      if(!res.ok) return;
      const data = await res.json();

      let contextUri = null, trackUri = null, openUrl = null;
      if (data.playlists?.items?.[0]) { const pl = data.playlists.items[0]; contextUri = pl.uri; openUrl = pl.external_urls?.spotify; }
      else if (data.tracks?.items?.[0]) { const t = data.tracks.items[0]; trackUri = t.uri; openUrl = t.external_urls?.spotify; }
      else { return; }

      setLastOpenUrl(openUrl);

      if (!(await isPremiumUser())) {
        if (openUrl) setLastOpenUrl(openUrl);
        return;
      }
      if (!(await ensureActiveDevice())) {
        if (openUrl) setLastOpenUrl(openUrl);
        return;
      }

      const body = contextUri ? { context_uri: contextUri } : { uris: [trackUri] };
      const playRes = await fetch('/play', { method:'PUT', credentials:'include', headers:{'content-type':'application/json'}, body: JSON.stringify(body) });
      if (!playRes.ok) {
        if (openUrl) setLastOpenUrl(openUrl);
      }
    }

    async function getLocationWithFallback() {
    // â‘  ã¾ãš ipapi ã‹ã‚‰ä½ç½®æƒ…å ±ã‚’å–å¾—ï¼ˆIPãƒ™ãƒ¼ã‚¹ï¼‰
      try {
        const resp = await fetch('https://ipapi.co/json/');
        if (!resp.ok) {
          console.warn('[geo] ipapi status:', resp.status);
          throw new Error('ipapi status ' + resp.status);
        }

        const j = await resp.json();
        // ipapi ã¯ latitude / longitude / city ã‚’è¿”ã—ã¦ãã‚Œã‚‹
        if (j && typeof j.latitude === 'number' && typeof j.longitude === 'number') {
          return {
            lat: j.latitude,
            lon: j.longitude,
            city: j.city || null,
            source: 'ipapi'
          };
        }

        throw new Error('ipapi response missing lat/lon');
      } catch (e) {
        console.warn('[geo] ipapi error, fallback to default Tokyo:', e);

        // â‘¡ ipapi ãŒãƒ€ãƒ¡ã ã£ãŸå ´åˆã¯æ±äº¬é§…ä»˜è¿‘ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«ã™ã‚‹
        return {
          lat: 35.681236,
          lon: 139.767125,
          city: 'æ±äº¬(ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)',
          source: 'default'
        };
      }
    }


    async function renderUserPlaylists(){
      const grid = document.getElementById('playlists');
      const tracksPanel = document.getElementById('playlist-tracks');
      if (!grid) return;

      grid.innerHTML = `<div style="opacity:.8;">èª­ã¿è¾¼ã¿ä¸­...</div>`;
      tracksPanel.innerHTML = '';

      const logged = await ensureLoggedIn();
      if (!logged) {
        grid.innerHTML = `<div style="opacity:.8;">æœªé€£æºã§ã™ã€‚ã€ŒSpotify é€£æº/æ›´æ–°ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚</div>`;
        return;
      }

      try {
        const data = await api('/playlists');
        const items = data.items || [];
        if (!items.length) {
          grid.innerHTML = `<div style="opacity:.8;">ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</div>`;
          return;
        }

        grid.innerHTML = items.map(p => {
          const img = p.image ? `<img src="${p.image}" alt="" style="width:100%;height:180px;object-fit:cover;border-radius:12px;">` : `<div style="width:100%;height:180px;background:#222;border-radius:12px;display:flex;align-items:center;justify-content:center;opacity:.6;">No Image</div>`;
          return `
            <div class="pl-card" data-plid="${p.id}" data-uri="${p.uri}" data-ext="${p.external_url || ''}" style="background:rgba(0,0,0,.25);border:1px solid #222;border-radius:14px;padding:10px;">
              <div class="pl-cover" style="position:relative;cursor:pointer;">
                ${img}
                <button class="play-btn" title="å†ç”Ÿ" style="position:absolute;right:8px;bottom:8px;border:none;border-radius:18px;padding:8px 12px;background:#1DB954;color:#fff;cursor:pointer;">â–¶</button>
              </div>
              <div style="margin-top:8px;font-weight:600;line-height:1.3;">${escapeHtml(p.name)}</div>
              <div style="opacity:.8;font-size:12px;margin-top:2px;">${p.tracks_total} æ›² â€¢ by ${escapeHtml(p.owner)}</div>
              <div style="display:flex;gap:8px;margin-top:8px;">
                <button class="open-btn" style="border:1px solid #333;background:transparent;color:#e6eef3;border-radius:8px;padding:6px 10px;cursor:pointer;">Spotifyã§è¦‹ã‚‹</button>
                <button class="tracks-btn" style="border:1px solid #333;background:transparent;color:#e6eef3;border-radius:8px;padding:6px 10px;cursor:pointer;">ãƒªã‚¹ãƒˆè©³ã—ãè¦‹ã‚‹</button>
              </div>
            </div>
          `;
        }).join('');

        grid.querySelectorAll('.pl-card').forEach(card => {
          const id = card.dataset.plid;
          const uri = card.dataset.uri;
          const ext = card.dataset.ext;

          card.querySelector('.pl-cover').addEventListener('click', () => {
            playSpotifyPlaylist({ id, uri, external_url: ext });
          });
          card.querySelector('.play-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            playSpotifyPlaylist({ id, uri, external_url: ext });
          });

          card.querySelector('.open-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            if (ext) window.open(ext, '_blank');
          });

          card.querySelector('.tracks-btn').addEventListener('click', async (e) => {
            e.stopPropagation();
            await renderTracksForPlaylist(id, card, tracksPanel);
          });
          addWeatherBtn(card, {
            id: id,
            name: card.querySelector('div[style*="font-weight"]').textContent
          });
        });

      } catch (e) {
        console.error('renderUserPlaylists error', e);
        grid.innerHTML = `<div style="opacity:.8;">ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</div>`;
      }
    }

    async function playSpotifyPlaylist(playlist){
      setLastOpenUrl(playlist.external_url || null);

      const logged = await ensureLoggedIn();
      if (!logged) return connectSpotify();

      if (!(await isPremiumUser())) {
        if (playlist.external_url) location.href = playlist.external_url;
        return;
      }

      const ok = await ensureActiveDevice();
      if (!ok) {
        if (playlist.external_url) location.href = playlist.external_url;
        return;
      }

      try {
        const res = await fetch('/play', {
          method:'PUT',
          credentials:'include',
          headers:{'content-type':'application/json'},
          body: JSON.stringify({ context_uri: playlist.uri })
        });
        if(!res.ok && playlist.external_url){
          location.href = playlist.external_url;
        }
      } catch (e) {
        console.error('play playlist error', e);
        if (playlist.external_url) location.href = playlist.external_url;
      }
    }

    async function renderTracksForPlaylist(playlistId, cardEl, panelEl){
      if (!panelEl) return;
      panelEl.innerHTML = `<div style="opacity:.8;">æ›²ç›®èª­ã¿è¾¼ã¿ä¸­...</div>`;
      try{
        const data = await api(`/playlist/${encodeURIComponent(playlistId)}/tracks?limit=100`);
        const items = data.items || [];
        if (!items.length) {
          panelEl.innerHTML = `<div style="opacity:.8;">æ›²ç›®ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
          return;
        }
        panelEl.innerHTML = `
          <h3 style="margin-top:12px;">æ›²ç›®ï¼ˆãƒˆãƒƒãƒ— ${items.length} æ›²ï¼‰</h3>
          <div style="display:grid;grid-template-columns:1fr;gap:10px;margin-top:8px;">
            ${items.map((t,i)=>`
              <div style="display:flex;gap:10px;align-items:center;background:rgba(0,0,0,.25);border:1px solid #222;border-radius:10px;padding:8px;">
                <div style="width:40px;text-align:right;opacity:.7;">${i+1}</div>
                ${t.image ? `<img src="${t.image}" style="width:40px;height:40px;object-fit:cover;border-radius:6px;">` : `<div style="width:40px;height:40px;background:#222;border-radius:6px;"></div>`}
                <div style="flex:1;min-width:0;">
                  <div style="font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${escapeHtml(t.name)}</div>
                  <div style="opacity:.8;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${escapeHtml((t.artists||[]).join(', '))}</div>
                </div>
                <button onclick="openTrackExternally('${t.external_url || ''}')" style="border:1px solid #333;background:transparent;color:#e6eef3;border-radius:8px;padding:6px 10px;cursor:pointer;">å†ç”Ÿ</button>
              </div>
            `).join('')}
          </div>
        `;
      }catch(e){
        console.error('renderTracksForPlaylist error', e);
        panelEl.innerHTML = `<div style="opacity:.8;">æ›²ç›®ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</div>`;
      }
    }

    function openTrackExternally(url){
      if (!url) return;
      window.open(url, '_blank');
    }

    function escapeHtml(s){
      return (s || '').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
    }

    async function logoutSpotify() {
      try {
        await fetch('/logout', { method: 'POST', credentials: 'include' });
        localStorage.removeItem('spotify_access_token');
        localStorage.removeItem('spotify_refresh_token');
    
        const logoutUrl = 'https://accounts.spotify.com/logout?continue=' 
                          + encodeURIComponent(window.location.origin + '/login.html');
        window.location.href = logoutUrl;
      } catch (err) {
        console.error('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå¤±æ•—:', err);
      }
    }
    
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«æ›´æ–°
        //updateNavLoginButton();
        function addWeatherBtn(card, pl) {
    ["sunny", "cloudy"].forEach(w => {
        const b = document.createElement("button");
        b.textContent = w === "sunny" ? "æ™´ã‚Œç”¨ã«ç™»éŒ²" : "æ›‡ã‚Šç”¨ã«ç™»éŒ²";

        b.onclick = async () => {

            if (!currentUserId) {
                alert("Spotifyã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„");
                return;
            }

            console.log(`${pl.name} ã‚’ ${w} ã«ç™»éŒ²`);

            try {
                const res = await fetch("/api/weather-playlist/add", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        uid: currentUserId,
                        weather: w,
                        pid: pl.id,
                        title: pl.name
                    })
                });

                const json = await res.json();
                console.log(json.message);

                if (json.ok) {
                    console.log("ç™»éŒ²æˆåŠŸ â†’ è¡¨ç¤ºæ›´æ–°");

                    // ã“ã“ãŒè¶…é‡è¦
                    await loadWeatherPlaylist(w);
                } else {
                    alert("ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ");
                }

            } catch (e) {
                console.error("ç™»éŒ²ã‚¨ãƒ©ãƒ¼", e);
            }
        };

        card.appendChild(b);
    });
}



        async function playByWeather(weather) {
            const res = await fetch(
                `/api/weather-playlist/random?uid=${currentUserId}&weather=${weather}`
            );
            const data = await res.json();

            if (data.found) {
                renderPlaylistIframe(
                    data.playlist.playlist_id,
                    data.playlist.title
                );
                return;
            }

            await createWeatherPlaylistIframe(weather);
        }





        function renderPlaylistIframe(pid, title = null) {
            const area = document.getElementById("weather-player");
            if (!area) return;

            area.innerHTML = `
            ${title ? `<h3>${title}</h3>` : ""}
            <iframe
                style="border-radius:12px"
                src="https://open.spotify.com/embed/playlist/${pid}"
                width="100%"
                height="380"
                frameborder="0"
                allow="encrypted-media"
                loading="lazy">
            </iframe>
            `;
        }

async function renderWeatherPlaylistFromDB(weather) {
  // ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã‘ã‚Œã°DBã¯ä½¿ã‚ãªã„
  const token = localStorage.getItem('spotify_token');
  if (!token || !currentUserId) {
    return false;
  }

  try {
    const res = await fetch(
      `/api/weather-playlist/random?uid=${encodeURIComponent(currentUserId)}&weather=${encodeURIComponent(weather)}`
    );

    // 200ä»¥å¤–ã¯ä½¿ã‚ãªã„
    if (!res.ok) {
      console.warn('[DB playlist] not ok', res.status);
      return false;
    }

    const data = await res.json();

    if (!data.found) {
      return false;
    }

    // iframeå·®ã—æ›¿ãˆ
    const frame = document.getElementById("playlist-frame");
    if (!frame) return false;

    frame.src = `https://open.spotify.com/embed/playlist/${data.playlist.playlist_id}`;

    return true;

  } catch (e) {
    console.error('[DB playlist load error]', e);
    return false;
  }
}


async function loadWeatherPlaylist(weather) {
    if (!currentUserId) return;

    try {
        const res = await fetch(
            `/api/weather-playlist/random?uid=${currentUserId}&weather=${weather}`
        );

        const json = await res.json();

        if (!json.found) {
            console.log("æœªç™»éŒ²ã®ãŸã‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¡¨ç¤º");
            return false;
        }

        // â˜… iframeã‚’ç›´æ¥æ¢ã•ãªã„
        renderWeatherPlaylistFromDB(weather, json.playlist.playlist_id);

        console.log("DBãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆè¡¨ç¤º:", json.playlist.playlist_id);
        return true;

    } catch (e) {
        console.error("loadWeatherPlaylist error", e);
        return false;
    }
}





function renderWeatherPlaylistFromDB(weather, playlistId) {
    const container = document.getElementById("weather-playlist");
    if (!container) return;

    const src =
        `https://open.spotify.com/embed/playlist/${encodeURIComponent(playlistId)}`;

    container.innerHTML = `
      <div class="playlist-card">
        <h4>ã‚ãªãŸãŒç™»éŒ²ã—ãŸãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆ</h4>
        <iframe
          id="playlist-frame"
          style="border-radius:12px"
          src="${src}"
          width="100%"
          height="352"
          frameborder="0"
          allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
          loading="lazy">
        </iframe>
      </div>
    `;
}




  </script>
  <script src="animation.js"></script>
</body>
</html>
