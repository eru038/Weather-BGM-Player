<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Weather BGM Player</title>
  <style>
    :root { --accent: #1db954; }
    body {
      margin: 0; min-height: 100vh; display: flex;
      background: linear-gradient(180deg, var(--accent) 0%, #0e0f12 60%);
      color: #e6eef3; font-family: "Segoe UI", sans-serif; transition: background 0.6s ease;
    }
    nav { width: 200px; background: rgba(0, 0, 0, 0.4); display: flex; flex-direction: column; align-items: start; padding: 20px; }
    nav button { background: none; border: none; color: white; font-size: 16px; margin: 10px 0; text-align: left; cursor: pointer; width: 100%; transition: 0.3s; }
    nav button:hover { color: var(--accent); }
    main { flex: 1; padding: 40px; opacity: 1; transition: opacity 0.5s ease; }
    main.fade-out { opacity: 0; }
    h1 { font-size: 28px; color: var(--accent); }
    .weather { margin-top: 20px; }
    .temp { font-size: 48px; }
    .spotify-btn { background: var(--accent); color: white; border: none; padding: 12px 24px; border-radius: 50px; font-size: 16px; cursor: pointer; margin-top: 20px; }
    .playlist-card { background: rgba(0, 0, 0, 0.25); border: 1px solid #222; border-radius: 12px; padding: 12px 16px; margin-top: 14px; }
    .playlist-card h4 { margin: 0; font-size: 18px; color: #f5f8fa; }
    .playlist-card p { margin: 4px 0 12px; opacity: .75; font-size: 14px; }
    .playlist-track { display: flex; gap: 12px; align-items: center; padding: 8px; border-radius: 8px; cursor: pointer; transition: background .25s ease; }
    .playlist-track:hover { background: rgba(255,255,255,0.08); }
    .playlist-track.active { background: rgba(30, 215, 96, 0.25); }
    .playlist-track .track-meta { flex: 1; min-width: 0; }
    .playlist-track .track-meta div { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .playlist-track .track-meta small { display: block; opacity: .7; font-size: 12px; }
    .muted { opacity: .65; }
    .color-picker { margin-top: 20px; }
    ul { list-style: none; padding: 0; }
    li { margin: 12px 0; cursor: pointer; transition: color 0.3s; }
    li:hover { color: var(--accent); }
    audio { margin-top: 20px; width: 100%; }
    #player-bar{position:sticky;bottom:0;left:0;right:0;padding:12px;border-top:1px solid #333;display:flex;gap:12px;align-items:center;background:rgba(0,0,0,0.6);backdrop-filter:blur(6px);}
    #player-bar button,#player-bar input[type=range]{cursor:pointer;}
    #player-bar .spacer{flex:1;}
    #premium-hint{display:none;margin-left:8px;opacity:.8;}
    #open-in-spotify{display:none;color:#1DB954;text-decoration:underline;}
  </style>
</head>
<body>
  <nav>
    <div id="user-info" style="color:#9fd8b7;margin-bottom:8px;"></div>
    <button onclick="changePage('home')">ğŸ  ãƒ›ãƒ¼ãƒ </button>
    <button onclick="changePage('playlist')">ğŸµ ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆ</button>
    <button onclick="changePage('settings')">âš™ï¸ è¨­å®š</button>
  </nav>

  <main id="content">
    <h1>Weather BGM Player</h1>
    <div id="weather-area"></div>
    <div style="margin-top:16px;display:flex;flex-wrap:wrap;gap:12px;align-items:center;">
      <button class="spotify-btn" onclick="playWeatherOnSpotify()">å¤©æ°—ã«åˆã‚ã›ã¦Spotifyã§å†ç”Ÿ</button>
      <button class="spotify-btn" style="background:#2b8a3e;" onclick="playWeatherLocally()">ãƒ–ãƒ©ã‚¦ã‚¶ã§BGMå†ç”Ÿ</button>
    </div>
    <div id="weather-playlist" style="margin-top:24px;"></div>
    <audio id="audio" controls></audio>
    <div id="player-bar">
      <button id="btn-prev">â®ï¸</button>
      <button id="btn-play">â–¶</button>
      <button id="btn-next">â­ï¸</button>
      <div id="current-track" class="muted" style="flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"></div>
      <div style="display:flex;align-items:center;gap:6px;margin-left:12px;">
        <span>ğŸ”Š</span>
        <input id="vol" type="range" min="0" max="100" value="50" />
      </div>
      <div class="spacer"></div>
      <a id="open-in-spotify" href="#" target="_blank">Spotifyã§ç¢ºèªã™ã‚‹</a>
      <span id="premium-hint" class="muted">PremiumãŒå¿…è¦</span>
    </div>
  </main>

  <script>
    const content = document.getElementById('content');
    const OWM_API_KEY = "0b0a5fb6ef2e3bc313bdc815bdcafd07";
    window.__CURRENT_PAGE__ = 'home'; 
    const LOCAL_VOLUME_KEY = 'localBgmVolume';
    const WEATHER_PLAYLIST_LIBRARY = {
      'Clear': {
        title: 'Sunlit Chill Vibes',
        description: 'å¿«æ™´ã®é’ç©ºã«ä¼¼åˆã†è»½å¿«ã§çˆ½ã‚„ã‹ãªBGMã‚»ãƒƒãƒˆã€‚',
        tracks: [
          { title: 'Sunny Days', artist: 'Komiku', mood: 'å¿ƒåœ°ã‚ˆã„ãƒãƒƒãƒ—', url: 'https://cdn.pixabay.com/download/audio/2022/03/15/audio_5b025d55f1.mp3?filename=sunny-days-11718.mp3' },
          { title: 'Sunshine', artist: 'RomanBelov', mood: 'ãã‚‰ã‚ãã‚·ãƒ³ã‚»', url: 'https://cdn.pixabay.com/download/audio/2023/05/13/audio_90f1aeefa7.mp3?filename=sunshine-146291.mp3' },
          { title: 'Happy Day', artist: 'AleXZavesa', mood: 'æ˜ã‚‹ã„ã‚¢ã‚³ãƒ¼ã‚¹ãƒ†ã‚£ãƒƒã‚¯', url: 'https://cdn.pixabay.com/download/audio/2022/10/16/audio_2c596cb8f0.mp3?filename=happy-day-124070.mp3' }
        ]
      },
      'Clouds': {
        title: 'Cloudy Afternoon Lounge',
        description: 'é›²ãŒåºƒãŒã‚‹åˆå¾Œã«ã—ã£ã¨ã‚Šã¨å¯„ã‚Šæ·»ã†ãƒ­ãƒ¼ãƒ•ã‚¡ã‚¤ã¨ã‚¢ãƒ³ãƒ“ã‚¨ãƒ³ãƒˆã€‚',
        tracks: [
          { title: 'Skyline', artist: 'Music_Unlimited', mood: 'ç©ã‚„ã‹ãªãƒ“ãƒ¼ãƒˆ', url: 'https://cdn.pixabay.com/download/audio/2022/02/14/audio_6edc6e6250.mp3?filename=skyline-10479.mp3' },
          { title: 'Calm and Peaceful', artist: 'Lesfm', mood: 'æŸ”ã‚‰ã‹ãªãƒ”ã‚¢ãƒ', url: 'https://cdn.pixabay.com/download/audio/2022/03/15/audio_aa56ed91e4.mp3?filename=calm-and-peaceful-11757.mp3' },
          { title: 'Soft Ambient', artist: 'Lesfm', mood: 'éœã®ã‚ˆã†ãªã‚·ãƒ³ã‚»', url: 'https://cdn.pixabay.com/download/audio/2022/05/26/audio_5dc50d0c82.mp3?filename=soft-ambient-11156.mp3' }
        ]
      },
      'Rain': {
        title: 'Rainy Day CafÃ©',
        description: 'é›¨ç²’ã®ãƒªã‚ºãƒ ã¨ã¨ã‚‚ã«é™ã‹ã«æµã‚Œã‚‹ãƒãƒ«ã‚¢ã‚¦ãƒˆãƒ»ã‚»ãƒƒãƒˆã€‚',
        tracks: [
          { title: 'Rainy Day Lofi', artist: 'Olexy', mood: 'ã—ã£ã¨ã‚Šãƒ­ãƒ¼ãƒ•ã‚¡ã‚¤', url: 'https://cdn.pixabay.com/download/audio/2022/10/25/audio_858e30b9ea.mp3?filename=rainy-day-lofi-124457.mp3' },
          { title: 'Raindrops Ambient Piano', artist: 'MusicLFiles', mood: 'ãƒ”ã‚¢ãƒã‚¢ãƒ³ãƒ“ã‚¨ãƒ³ãƒˆ', url: 'https://cdn.pixabay.com/download/audio/2021/11/16/audio_550be218b5.mp3?filename=raindrops-ambient-piano-110397.mp3' },
          { title: 'Midnight Walk', artist: 'FASSounds', mood: 'é™ã‹ãªå¤œã®æ•£æ­©', url: 'https://cdn.pixabay.com/download/audio/2022/10/03/audio_bf9114ef95.mp3?filename=midnight-walk-122420.mp3' }
        ]
      },
      'Drizzle': {
        title: 'Light Rain Lofi',
        description: 'éœ§é›¨ã®ã‚ˆã†ã«æŸ”ã‚‰ã‹ã„ã‚µã‚¦ãƒ³ãƒ‰ã§é›†ä¸­ã¨ãƒªãƒ©ãƒƒã‚¯ã‚¹ã‚’ã‚µãƒãƒ¼ãƒˆã€‚',
        tracks: [
          { title: 'Light Rain Lofi', artist: 'Olexy', mood: 'ã—ã¨ã—ã¨ãƒ“ãƒ¼ãƒˆ', url: 'https://cdn.pixabay.com/download/audio/2022/11/09/audio_211f5b02c2.mp3?filename=light-rain-lofi-125564.mp3' },
          { title: 'Coffee Shop Vibes', artist: 'Lofi_hour', mood: 'ã‚«ãƒ•ã‚§ã®ã–ã‚ã‚ã', url: 'https://cdn.pixabay.com/download/audio/2022/09/03/audio_6ce9f204dd.mp3?filename=coffee-shop-vibes-12039.mp3' },
          { title: 'Soft Lofi', artist: 'SoulProdMusic', mood: 'æ·¡ã„ãƒ¡ãƒ­ãƒ‡ã‚£', url: 'https://cdn.pixabay.com/download/audio/2022/08/04/audio_9a85f1e4b7.mp3?filename=soft-lofi-113081.mp3' }
        ]
      },
      'Thunderstorm': {
        title: 'Stormy Night Cinematics',
        description: 'é›·é³´ã«è² ã‘ãªã„ãƒ‰ãƒ©ãƒãƒ†ã‚£ãƒƒã‚¯ãªã‚¢ãƒ³ãƒ“ã‚¨ãƒ³ãƒˆã¨ã‚·ãƒãƒãƒ†ã‚£ãƒƒã‚¯ã€‚',
        tracks: [
          { title: 'Storm Ambient', artist: 'Lesfm', mood: 'é›·é³´ã‚’æ„Ÿã˜ã‚‹ãƒ‰ãƒ­ãƒ¼ãƒ³', url: 'https://cdn.pixabay.com/download/audio/2021/10/16/audio_db5c81e197.mp3?filename=storm-ambient-113122.mp3' },
          { title: 'Heroic Trailer', artist: 'ZakharValaha', mood: 'å£®å¤§ãªã‚¹ãƒˆãƒªãƒ³ã‚°ã‚¹', url: 'https://cdn.pixabay.com/download/audio/2021/10/21/audio_33fe577b6f.mp3?filename=epic-cinematic-heroic-trailer-113268.mp3' },
          { title: 'Dark Sky Ambient', artist: 'Lesfm', mood: 'ä½ãé³´ã‚‹ã‚µã‚¦ãƒ³ãƒ‰ã‚¹ã‚±ãƒ¼ãƒ—', url: 'https://cdn.pixabay.com/download/audio/2021/12/17/audio_f12ac55711.mp3?filename=dark-sky-ambient-9967.mp3' }
        ]
      },
      'Snow': {
        title: 'Cozy Winter Lullaby',
        description: 'é›ªæ™¯è‰²ã‚’çœºã‚ãªãŒã‚‰æ¸©ã‹ã„é£²ã¿ç‰©ã¨æ¥½ã—ã¿ãŸã„ã‚¹ãƒ­ãƒ¼BGMã€‚',
        tracks: [
          { title: 'Winter Memories', artist: 'Musictown', mood: 'æŸ”ã‚‰ã‹ãªãƒ™ãƒ«', url: 'https://cdn.pixabay.com/download/audio/2022/01/11/audio_45a7dc7cb4.mp3?filename=winter-memories-ambient-10061.mp3' },
          { title: 'Warm Winter Night', artist: 'Lesfm', mood: 'æš–ç‚‰ã®ã‚ˆã†ãªãƒ­ãƒ¼ãƒ•ã‚¡ã‚¤', url: 'https://cdn.pixabay.com/download/audio/2021/09/01/audio_7a0b9ef591.mp3?filename=warm-winter-night-112195.mp3' },
          { title: 'Winter Sunshine', artist: 'PianoAmor', mood: 'ã—ã£ã¨ã‚Šãƒ”ã‚¢ãƒ', url: 'https://cdn.pixabay.com/download/audio/2021/11/25/audio_052e03d32a.mp3?filename=winter-sunshine-110600.mp3' }
        ]
      },
      'Mist': {
        title: 'Mist & Fog Soundscapes',
        description: 'éœ§ã‚„é„ã®æœã«ã´ã£ãŸã‚Šãªå¹»æƒ³çš„ã‚¢ãƒ³ãƒ“ã‚¨ãƒ³ãƒˆã€‚',
        tracks: [
          { title: 'Foggy Ambient', artist: 'FASSounds', mood: 'éœã‚€ãƒ‘ãƒƒãƒ‰', url: 'https://cdn.pixabay.com/download/audio/2023/02/27/audio_b040b64359.mp3?filename=foggy-ambient-140822.mp3' },
          { title: 'Calm Mist', artist: 'SoulProdMusic', mood: 'é™ã‹ãªæºã‚‰ã', url: 'https://cdn.pixabay.com/download/audio/2023/02/03/audio_f27aa49ef2.mp3?filename=calm-mist-138820.mp3' },
          { title: 'Misty Forest', artist: 'Lesfm', mood: 'æ£®ã‚’åŒ…ã‚€éœ§', url: 'https://cdn.pixabay.com/download/audio/2021/10/23/audio_b6f7267c79.mp3?filename=misty-forest-113235.mp3' }
        ]
      },
      'Fog': null,
      'Haze': null,
      'Smoke': null,
      'Default': {
        title: 'Daily Focus Mix',
        description: 'æ°—åˆ†ã«å¯„ã‚Šæ·»ã†ç©ã‚„ã‹ãªãƒãƒ«ã‚¢ã‚¦ãƒˆBGMã€‚',
        tracks: [
          { title: 'Chillhop Vibes', artist: 'Lesfm', mood: 'æ»‘ã‚‰ã‹ãªãƒ“ãƒ¼ãƒˆ', url: 'https://cdn.pixabay.com/download/audio/2023/03/23/audio_9aac8e3591.mp3?filename=chillhop-vibes-142396.mp3' },
          { title: 'Lofi Chillhop', artist: 'Infraction', mood: 'è½ã¡ç€ããƒ”ã‚¢ãƒ', url: 'https://cdn.pixabay.com/download/audio/2022/06/08/audio_9b14b3db3f.mp3?filename=lofi-chillhop-11457.mp3' },
          { title: 'Night Jazz', artist: 'RomanBelov', mood: 'å¤œã®ã‚¸ãƒ£ã‚º', url: 'https://cdn.pixabay.com/download/audio/2021/12/13/audio_795882ec58.mp3?filename=night-jazz-110255.mp3' }
        ]
      }
    };
    const localPlaybackState = {
      playlist: null,
      currentIndex: -1,
      volume: null
    };

    (function restoreFromParam(){
      const from = new URLSearchParams(location.search).get('from');
      if (from) {
        changePage(from);
        history.replaceState({}, '', location.origin + location.pathname);
      }
    })();

    function changePage(page) {
      window.__CURRENT_PAGE__ = page;
      content.classList.add("fade-out");
      setTimeout(() => {
        if (page === "home") {
          content.innerHTML = `
            <h1>Weather BGM Player</h1>
            <div id="weather-area"></div>
            <div style="margin-top:16px;display:flex;flex-wrap:wrap;gap:12px;align-items:center;">
              <button class="spotify-btn" onclick="playWeatherOnSpotify()">å¤©æ°—ã«åˆã‚ã›ã¦Spotifyã§å†ç”Ÿ</button>
              <button class="spotify-btn" style="background:#2b8a3e;" onclick="playWeatherLocally()">ãƒ–ãƒ©ã‚¦ã‚¶ã§BGMå†ç”Ÿ</button>
            </div>
            <div id="weather-playlist" style="margin-top:24px;"></div>
            <audio id="audio" controls></audio>
            <div id="player-bar">
              <button id="btn-prev">â®ï¸</button>
              <button id="btn-play">â–¶</button>
              <button id="btn-next">â­ï¸</button>
              <div id="current-track" class="muted" style="flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"></div>
              <div style="display:flex;align-items:center;gap:6px;margin-left:12px;">
                <span>ğŸ”Š</span>
                <input id="vol" type="range" min="0" max="100" value="50" />
              </div>
              <div class="spacer"></div>
              <a id="open-in-spotify" href="#" target="_blank">Spotifyã§è´ã</a>
              <span id="premium-hint" class="muted">PremiumãŒå¿…è¦</span>
            </div>
          `;
          renderWeatherPlaylist(window.__WEATHER_MAIN__ || 'Default');
          loadWeather(); bindControlEvents(); initControls();
        } else if (page === "playlist") {
          content.innerHTML = `
            <h1>ğŸµ ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆ</h1>
            <div id="playlist-toolbar" style="margin-bottom:12px;display:flex;gap:12px;align-items:center;">
              <button class="spotify-btn" onclick="connectSpotify()">Spotify é€£æº/æ›´æ–°</button>
              <span style="opacity:.8;font-size:14px;">ã‚µãƒ ãƒã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„</span>
            </div>
            <div id="playlists" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:16px;"></div>
            <div id="playlist-tracks" style="margin-top:20px;"></div>
            <div id="player-bar">
              <button id="btn-prev">â®ï¸</button>
              <button id="btn-play">â–¶</button>
              <button id="btn-next">â­ï¸</button>
              <div id="current-track" class="muted" style="flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"></div>
              <div style="display:flex;align-items:center;gap:6px;margin-left:12px;">
                <span>ğŸ”Š</span>
                <input id="vol" type="range" min="0" max="100" value="50" />
              </div>
              <div class="spacer"></div>
              <a id="open-in-spotify" href="#" target="_blank">åœ¨ Spotify ä¸­æ‰“å¼€</a>
              <span id="premium-hint" class="muted">éœ€è¦ Premium æ‰èƒ½ç½‘é¡µå†…æ§åˆ¶</span>
            </div>
          `;
          bindControlEvents(); initControls();
          renderUserPlaylists();   
        } else if (page === "settings") {
          content.innerHTML = `
            <h1>âš™ï¸ è¨­å®š</h1>
            <button class="spotify-btn" onclick="connectSpotify()">Spotify é€£æº</button>
            <!-- settingsãƒšãƒ¼ã‚¸ã«è¿½åŠ  -->
            <button class="spotify-btn" onclick="logoutSpotify()" style="margin-top:10px;background:#ff4d4d;">Spotify ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>

            <div class="color-picker">
              <label>ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã‚’é¸æŠï¼š</label>
              <input type="color" id="color-input" />
            </div>
          `;
          setupColorPicker(); initControls(); 
        }
        content.classList.remove("fade-out");
      }, 400);
    }

    function resolveWeatherKey(main) {
      if (WEATHER_PLAYLIST_LIBRARY[main]) return main;
      if (['Mist', 'Fog', 'Haze', 'Smoke'].includes(main) && WEATHER_PLAYLIST_LIBRARY['Mist']) return 'Mist';
      if (WEATHER_PLAYLIST_LIBRARY['Default']) return 'Default';
      const firstKey = Object.keys(WEATHER_PLAYLIST_LIBRARY).find(k => WEATHER_PLAYLIST_LIBRARY[k] && WEATHER_PLAYLIST_LIBRARY[k].tracks?.length);
      return firstKey || 'Default';
    }

    function getWeatherPlaylist(main) {
      const key = resolveWeatherKey(main || 'Default');
      const playlist = WEATHER_PLAYLIST_LIBRARY[key];
      return playlist || WEATHER_PLAYLIST_LIBRARY['Default'] || null;
    }

    function updateCurrentTrackLabel(text) {
      const label = document.getElementById('current-track');
      if (!label) return;
      label.textContent = text || '';
    }

    function highlightLocalTrack() {
      const container = document.getElementById('weather-playlist');
      if (!container) return;
      container.querySelectorAll('.playlist-track').forEach(el => {
        const idx = Number(el.dataset.index);
        if (idx === localPlaybackState.currentIndex) el.classList.add('active');
        else el.classList.remove('active');
      });
    }

    function renderWeatherPlaylist(main) {
      const container = document.getElementById('weather-playlist');
      if (!container) return;
      const playlist = getWeatherPlaylist(main);
      if (!playlist) {
        container.innerHTML = '';
        localPlaybackState.playlist = null;
        localPlaybackState.currentIndex = -1;
        updateCurrentTrackLabel('');
        return;
      }

      localPlaybackState.playlist = playlist;
      if (playlist.tracks?.length) {
        localPlaybackState.currentIndex = Math.min(Math.max(localPlaybackState.currentIndex, 0), playlist.tracks.length - 1);
      } else {
        localPlaybackState.currentIndex = -1;
      }

      const tracksHtml = (playlist.tracks || []).map((track, idx) => `
        <div class="playlist-track" data-index="${idx}">
          <span style="width:28px;opacity:.7;">${idx + 1}</span>
          <div class="track-meta">
            <div>${escapeHtml(track.title || 'Untitled')}</div>
            <small>${escapeHtml(track.artist || 'Unknown Artist')} â€¢ ${escapeHtml(track.mood || '')}</small>
          </div>
          <span style="opacity:.5;font-size:12px;">â–¶</span>
        </div>
      `).join('');

      container.innerHTML = `
        <div class="playlist-card">
          <h4>${escapeHtml(playlist.title || 'Weather Playlist')}</h4>
          <p>${escapeHtml(playlist.description || '')}</p>
          <div>${tracksHtml}</div>
          <div class="muted" style="margin-top:12px;font-size:12px;">â€» Pixabayæ²è¼‰ã®ãƒ•ãƒªãƒ¼BGMã‚’ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å†ç”Ÿã—ã¦ã„ã¾ã™ã€‚</div>
        </div>
      `;

      container.querySelectorAll('.playlist-track').forEach(el => {
        el.addEventListener('click', () => {
          const idx = Number(el.dataset.index || '0');
          playLocalTrack(idx);
        });
      });

      highlightLocalTrack();
      const currentTrack = playlist.tracks?.[localPlaybackState.currentIndex];
      if (currentTrack) updateCurrentTrackLabel(`ğŸ¶ ${currentTrack.title} - ${currentTrack.artist}`);
      else updateCurrentTrackLabel('');
    }

    function ensureLocalVolume(player, slider) {
      if (!player) return;
      if (localPlaybackState.volume === null) {
        const saved = parseFloat(localStorage.getItem(LOCAL_VOLUME_KEY));
        localPlaybackState.volume = (Number.isFinite(saved) && saved >= 0 && saved <= 1) ? saved : 0.5;
      }
      player.volume = localPlaybackState.volume;
      if (slider) slider.value = Math.round(localPlaybackState.volume * 100);
    }

    function setLocalVolume(value) {
      localPlaybackState.volume = value;
      localStorage.setItem(LOCAL_VOLUME_KEY, String(value));
    }

    function setupLocalAudioElement() {
      const player = document.getElementById('audio');
      if (!player) return;
      if (player.__listenersBound) return;
      const slider = document.getElementById('vol');
      ensureLocalVolume(player, slider);
      player.addEventListener('ended', () => {
        if (localPlaybackState.playlist?.tracks?.length) {
          playLocalNext();
        }
      });
      player.addEventListener('play', () => setPlayButtonState(true));
      player.addEventListener('pause', () => setPlayButtonState(false));
      player.__listenersBound = true;
    }

    function setPlayButtonState(playing) {
      const btn = document.getElementById('btn-play');
      if (!btn) return;
      btn.textContent = playing ? 'â¸ï¸' : 'â–¶';
    }

    function getCurrentLocalTrack() {
      const playlist = localPlaybackState.playlist;
      if (!playlist || !playlist.tracks?.length) return null;
      if (localPlaybackState.currentIndex < 0 || localPlaybackState.currentIndex >= playlist.tracks.length) return null;
      return playlist.tracks[localPlaybackState.currentIndex];
    }

    function playLocalTrack(index) {
      const playlist = localPlaybackState.playlist;
      if (!playlist || !playlist.tracks?.length) return;
      const player = document.getElementById('audio');
      if (!player) return;

      const boundedIndex = (index >= 0 && index < playlist.tracks.length) ? index : 0;
      localPlaybackState.currentIndex = boundedIndex;
      const track = playlist.tracks[boundedIndex];
      player.src = track.url;
      player.play().catch(() => {});
      highlightLocalTrack();
      updateCurrentTrackLabel(`ğŸ¶ ${track.title} - ${track.artist}`);
      setPlayButtonState(true);
    }

    function playLocalNext() {
      const playlist = localPlaybackState.playlist;
      if (!playlist || !playlist.tracks?.length) return;
      const nextIndex = (localPlaybackState.currentIndex + 1) % playlist.tracks.length;
      playLocalTrack(nextIndex);
    }

    function playLocalPrev() {
      const playlist = localPlaybackState.playlist;
      if (!playlist || !playlist.tracks?.length) return;
      const len = playlist.tracks.length;
      const nextIndex = (localPlaybackState.currentIndex - 1 + len) % len;
      playLocalTrack(nextIndex);
    }

    function toggleLocalPlayPause() {
      const player = document.getElementById('audio');
      if (!player) return;
      if (!player.src) {
        if (localPlaybackState.playlist?.tracks?.length) {
          playLocalTrack(localPlaybackState.currentIndex >= 0 ? localPlaybackState.currentIndex : 0);
        }
        return;
      }
      if (player.paused) player.play().catch(() => {});
      else player.pause();
    }

    function playWeatherLocally() {
      const main = window.__WEATHER_MAIN__ || 'Clouds';
      if (!localPlaybackState.playlist || getCurrentLocalTrack() === null) {
        renderWeatherPlaylist(main);
      }
      const track = getCurrentLocalTrack();
      if (track) playLocalTrack(localPlaybackState.currentIndex);
    }

    function setupColorPicker() {
      const colorInput = document.getElementById('color-input');
      const savedAccent = localStorage.getItem('accentColor');
      if (savedAccent) {
        colorInput.value = savedAccent;
        document.documentElement.style.setProperty('--accent', savedAccent);
        document.body.style.background = `linear-gradient(180deg, ${savedAccent} 0%, #0e0f12 60%)`;
      }
      colorInput.addEventListener('input', () => {
        const newColor = colorInput.value;
        document.documentElement.style.setProperty('--accent', newColor);
        localStorage.setItem('accentColor', newColor);
        document.body.style.background = `linear-gradient(180deg, ${newColor} 0%, #0e0f12 60%)`;
      });
    }

    async function loadWeather() {
      const area = document.getElementById('weather-area');
      if (!area) return;

      try {
        const loc = await getLocationWithFallback();
        const lat = loc.lat;
        const lon = loc.lon;
        const cityFromGeo = loc.city;

        const url = `https://api.openweathermap.org/data/2.5/weather?lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}&units=metric&lang=ja&appid=${encodeURIComponent(OWM_API_KEY)}`;
        const wRes = await fetch(url);

        if (!wRes.ok) {
          const txt = await wRes.text().catch(() => '');
          console.error('[weather] OWM not ok', wRes.status, txt);
          if (wRes.status === 401) {
            area.innerHTML = `<p>OpenWeatherMapã®APIã‚­ãƒ¼ãŒç„¡åŠ¹ã§ã™ï¼ˆ401ï¼‰ã€‚ã‚­ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>`;
          } else if (wRes.status === 429) {
            area.innerHTML = `<p>ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå¤šã™ãã¾ã™ï¼ˆ429ï¼‰ã€‚å°‘ã—å¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚</p>`;
          } else {
            area.innerHTML = `<p>å¤©æ°—æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆ${wRes.status}ï¼‰ã€‚</p>`;
          }
          return;
        }

        const wData = await wRes.json();

        const temp = Math.round(wData?.main?.temp ?? NaN);
        const weather = wData?.weather?.[0]?.description || 'â€”';
        const main = wData?.weather?.[0]?.main || 'Clouds';
        const city = cityFromGeo || wData?.name || 'â€”';

        let icon = "ğŸŒˆ"; let accent = "#1db954";
        switch (main) {
          case "Clear": icon = "â˜€ï¸"; accent = "#f7b733"; break;
          case "Clouds": icon = "â˜ï¸"; accent = "#5f9ea0"; break;
          case "Rain": icon = "ğŸŒ§ï¸"; accent = "#4a90e2"; break;
          case "Drizzle": icon = "ğŸŒ¦ï¸"; accent = "#6ec6ff"; break;
          case "Thunderstorm": icon = "â›ˆï¸"; accent = "#3b3b98"; break;
          case "Snow": icon = "â„ï¸"; accent = "#00bcd4"; break;
          case "Mist":
          case "Fog": icon = "ğŸŒ«ï¸"; accent = "#aab2bd"; break;
        }

        const savedAccent = localStorage.getItem('accentColor');
        const finalAccent = savedAccent || accent;
        document.documentElement.style.setProperty('--accent', finalAccent);
        document.body.style.background = `linear-gradient(180deg, ${finalAccent} 0%, #0e0f12 60%)`;

        const tempHtml = isNaN(temp) ? 'â€”' : `${temp}Â°C`;
        area.innerHTML = `
          <div class="weather">
            <h3>${city} ã®å¤©æ°—</h3>
            <p>${icon} ${weather}</p>
            <div class="temp">${tempHtml}</div>
            <div style="margin-top:6px;opacity:.7;font-size:14px;">ãƒ‡ãƒ¼ã‚¿å…ƒ: ${loc.source === 'browser' ? 'ãƒ–ãƒ©ã‚¦ã‚¶ä½ç½®æƒ…å ±' : loc.source === 'ipapi' ? 'IPä½ç½®æƒ…å ±' : 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ'}</div>
          </div>
        `;

        window.__WEATHER_MAIN__ = main;
        renderWeatherPlaylist(main);

      } catch (e) {
        console.error('[weather] error:', e);
        if (area) area.innerHTML = `<p>å¤©æ°—æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>`;
        window.__WEATHER_MAIN__ = 'Default';
        renderWeatherPlaylist('Default');
      }
    }

    window.onload = () => {
      const savedAccent = localStorage.getItem('accentColor');
      if (savedAccent) {
        document.documentElement.style.setProperty('--accent', savedAccent);
        document.body.style.background = `linear-gradient(180deg, ${savedAccent} 0%, #0e0f12 60%)`;
      }
      renderWeatherPlaylist('Default');
      loadWeather(); loadBattery(); bindControlEvents(); initControls();
    };

    async function loadBattery() {
      try {
        const battery = await navigator.getBattery();
        const area = document.getElementById('weather-area'); if (!area) return;
        const updateBattery = () => {
          const level = Math.round(battery.level * 100);
          const charging = battery.charging ? "âš¡å……é›»ä¸­" : "";
          let icon = "ğŸ”‹";
          if (level <= 20) icon = "ğŸª«";
          else if (level <= 50) icon = "ğŸ”‹";
          else if (level <= 80) icon = "ğŸ”‹ğŸ”‹";
          else icon = "ğŸ”‹ğŸ”‹ğŸ”‹";
          const batteryInfo = document.getElementById("battery-info");
          const html = `${icon} ${level}% ${charging}`;
          if (batteryInfo) batteryInfo.innerHTML = html;
          else {
            const div = document.createElement("div");
            div.id = "battery-info"; div.style.marginTop = "10px"; div.style.fontSize = "18px";
            div.innerHTML = html;
            area.appendChild(div);
          }
        };
        updateBattery();
        battery.addEventListener('levelchange', updateBattery);
        battery.addEventListener('chargingchange', updateBattery);
      } catch (e) { console.error("Battery APIã‚¨ãƒ©ãƒ¼:", e); }
    }

    // ===== Spotify OAuth + Playback =====

    (function ensureSdk(){
      const s = document.createElement('script'); s.src = "https://sdk.scdn.co/spotify-player.js";
      document.head.appendChild(s);
    })();

    async function api(path, opts={}){
      const res = await fetch(path, {credentials:'include', ...opts});
      if(!res.ok) throw new Error(path+' '+res.status);
      const ct = res.headers.get('content-type')||'';
      if(ct.includes('application/json')) return res.json();
      return res.text();
    }

    function connectSpotify(){
      const from = window.__CURRENT_PAGE__ || 'home';
      window.location.href = '/login?from=' + encodeURIComponent(from);
    }
    async function logoutSpotify() {
  try {
    // ã‚µãƒ¼ãƒãƒ¼å´ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³å‰Šé™¤
    await fetch('/logout', { method: 'POST', credentials: 'include' });
  } catch (e) {
    console.warn('logout error', e);
  }

  // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ãƒªã‚»ãƒƒãƒˆ
  IS_PREMIUM = false;
  LAST_OPEN_URL = null;
  spotifyPlayer = null;
  spotifyDeviceId = null;

  const info = document.getElementById('user-info');
  if (info) info.textContent = '';

  setControlsDisabled(true);
  const openLink = document.getElementById('open-in-spotify');
  const hint = document.getElementById('premium-hint');
  if (openLink) openLink.style.display = 'none';
  if (hint) hint.style.display = 'none';

  // ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚„æ›²ãƒ‘ãƒãƒ«ã‚¯ãƒªã‚¢
  const playlistGrid = document.getElementById('playlists');
  const tracksPanel = document.getElementById('playlist-tracks');
  if (playlistGrid) playlistGrid.innerHTML = '';
  if (tracksPanel) tracksPanel.innerHTML = '';

  // è¨­å®šãƒšãƒ¼ã‚¸ã®ãƒœã‚¿ãƒ³æ–‡è¨€æ›´æ–°
  if (window.__CURRENT_PAGE__ === 'settings') {
    const btn = document.querySelector('.spotify-btn');
    if (btn) btn.textContent = 'Spotify é€£æº/æ›´æ–°';
  }

  alert('Spotifyã‹ã‚‰ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚');
}

    let spotifyPlayer = null, spotifyDeviceId = null, IS_PREMIUM = false, LAST_OPEN_URL = null;

    async function fetchAccessToken(){ const r = await fetch('/token', {credentials:'include'}); if(!r.ok) return null; const j = await r.json(); return j.access_token; }
    async function ensureLoggedIn(){ try{ const me = await api('/me'); IS_PREMIUM = (me.product === 'premium'); return true; }catch{ return false; } }
    async function isPremiumUser(){ return IS_PREMIUM; }
    function setLastOpenUrl(url){
      LAST_OPEN_URL = url || null;
      const openLink = document.getElementById('open-in-spotify');
      const hint = document.getElementById('premium-hint');
      if(!openLink || !hint) return;
      if(IS_PREMIUM){ openLink.style.display = 'none'; hint.style.display = 'none'; }
      else { if (LAST_OPEN_URL){ openLink.style.display = 'inline'; openLink.href = LAST_OPEN_URL; } else openLink.style.display = 'none'; hint.style.display = 'inline'; }
    }
    function setControlsDisabled(disabled){ ['btn-prev','btn-play','btn-next','vol'].forEach(id=>{ const el=document.getElementById(id); if (el) el.disabled = disabled; }); }
    function bindControlEvents(){
      const btnPrev=document.getElementById('btn-prev'); const btnPlay=document.getElementById('btn-play'); const btnNext=document.getElementById('btn-next'); const vol=document.getElementById('vol');
      let isPaused = true;
      setupLocalAudioElement();

      if (btnPrev) btnPrev.onclick = async ()=>{
        if (IS_PREMIUM && spotifyPlayer){ try { await spotifyPlayer.previousTrack(); } catch(e){} }
        else { playLocalPrev(); }
      };

      if (btnPlay) btnPlay.onclick = async ()=>{
        if (IS_PREMIUM && spotifyPlayer){
          try { if (isPaused) await spotifyPlayer.resume(); else await spotifyPlayer.pause(); }
          catch(e){}
        } else {
          toggleLocalPlayPause();
        }
      };

      if (btnNext) btnNext.onclick = async ()=>{
        if (IS_PREMIUM && spotifyPlayer){ try { await spotifyPlayer.nextTrack(); } catch(e){} }
        else { playLocalNext(); }
      };

      if (vol) vol.oninput = async (e)=>{
        const v=Math.max(0,Math.min(1,e.target.value/100));
        if (IS_PREMIUM && spotifyPlayer){
          try { await spotifyPlayer.setVolume(v); }
          catch(e){}
        } else {
          const player = document.getElementById('audio');
          if (player){ player.volume = v; setLocalVolume(v); }
        }
      };

      if (!IS_PREMIUM || !spotifyPlayer){
        const player = document.getElementById('audio');
        ensureLocalVolume(player, vol);
      }

      if (window.Spotify && spotifyPlayer) {
        spotifyPlayer.addListener('player_state_changed', state => {
          if (!state) return; isPaused = state.paused;
          setPlayButtonState(!isPaused);
          if (vol && typeof state.device?.volume_percent === 'number') vol.value = state.device.volume_percent;
        });
      }
    }
    async function initControls(){
      const info = document.getElementById('user-info');
      const logged = await ensureLoggedIn();

      if (!logged){
        if (info) info.textContent = '';
        setControlsDisabled(false);
        const a=document.getElementById('open-in-spotify'); const h=document.getElementById('premium-hint');
        if(a) a.style.display='none'; if(h) h.style.display='none';
        return;
      }

      try{
        const me = await api('/me');
        if (info) info.textContent = `ğŸ§ ${me.display_name || me.id}`;
        if (window.__CURRENT_PAGE__ === 'settings') {
          const btn = document.querySelector('.spotify-btn');
          if (btn) btn.textContent = `Spotify é€£æºæ¸ˆã¿ï¼ˆ${me.display_name || me.id}ï¼‰`;
        }
      }catch{}

      if (IS_PREMIUM){
        setControlsDisabled(false);
        const a=document.getElementById('open-in-spotify'); const h=document.getElementById('premium-hint');
        if(a) a.style.display='none'; if(h) h.style.display='none';
      }else{
        setControlsDisabled(false);
        const h=document.getElementById('premium-hint'); if(h) h.style.display='inline';
        if (LAST_OPEN_URL){ const a=document.getElementById('open-in-spotify'); if(a){ a.style.display='inline'; a.href=LAST_OPEN_URL; } }
      }
    }

    window.onSpotifyWebPlaybackSDKReady = async () => {
      const token = await fetchAccessToken(); if(!token) return;
      spotifyPlayer = new Spotify.Player({
        name: 'Weather BGM (Web Player)',
        getOAuthToken: async cb => { const t = await fetchAccessToken(); if (t) cb(t); },
        volume: 0.5
      });
      spotifyPlayer.addListener('initialization_error', ({ message }) => console.error(message));
      spotifyPlayer.addListener('authentication_error', ({ message }) => console.error(message));
      spotifyPlayer.addListener('account_error', ({ message }) => console.error(message));
      spotifyPlayer.addListener('playback_error', ({ message }) => console.error(message));
      spotifyPlayer.addListener('ready', ({ device_id }) => { spotifyDeviceId = device_id; });
      spotifyPlayer.addListener('not_ready', ({ device_id }) => {});
      await spotifyPlayer.connect();
    };

    const WEATHER_TO_QUERY = {
      'Clear': ['summer vibes', 'sunny chill', 'city pop'],
      'Rain': ['rainy day jazz', 'lofi rain', 'ambient rain'],
      'Drizzle': ['rainy cafe', 'lofi rain'],
      'Thunderstorm': ['dark ambient', 'cinematic storm'],
      'Snow': ['cozy winter', 'winter jazz'],
      'Clouds': ['cloudy day indie', 'indie chill'],
      'Mist': ['ambient mist', 'dream pop'],
      'Fog': ['ambient fog', 'deep focus']
    };

    async function waitForDeviceReady(timeoutMs = 8000) {
      const start = Date.now();
      while (!spotifyDeviceId && (Date.now() - start) < timeoutMs) { await new Promise(r => setTimeout(r, 200)); }
      return Boolean(spotifyDeviceId);
    }
    async function ensureActiveDevice() {
      const hasDevice = await waitForDeviceReady();
      if (hasDevice) {
        await fetch('/transfer', { method:'PUT', credentials:'include', headers:{'content-type':'application/json'}, body: JSON.stringify({device_id: spotifyDeviceId}) });
        return true;
      }
      try { const list = await api('/devices'); const active = list.devices?.find(d => d.is_active); if (active) return true; }catch{}
      alert('Spotifyãƒ‡ãƒã‚¤ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
      return false;
    }

    async function playWeatherOnSpotify(){
      const main = window.__WEATHER_MAIN__ || 'Clouds'; await pickSpotifyAndPlay(main);
    }

    async function pickSpotifyAndPlay(weatherMain){
      const loggedIn = await ensureLoggedIn();
      if(!loggedIn){ return connectSpotify(); }
      const token = await fetchAccessToken(); if(!token) return;

      const queries = WEATHER_TO_QUERY[weatherMain] || WEATHER_TO_QUERY['Clouds'];
      const q = encodeURIComponent(queries[0]);
      const res = await fetch('https://api.spotify.com/v1/search?type=playlist,track&limit=1&q='+q, { headers: { Authorization: 'Bearer '+token } });
      if(!res.ok) return;
      const data = await res.json();

      let contextUri = null, trackUri = null, openUrl = null;
      if (data.playlists?.items?.[0]) { const pl = data.playlists.items[0]; contextUri = pl.uri; openUrl = pl.external_urls?.spotify; }
      else if (data.tracks?.items?.[0]) { const t = data.tracks.items[0]; trackUri = t.uri; openUrl = t.external_urls?.spotify; }
      else { return; }

      setLastOpenUrl(openUrl);

      if (!(await isPremiumUser())) {
        if (openUrl) setLastOpenUrl(openUrl);
        playWeatherLocally();
        return;
      }
      if (!(await ensureActiveDevice())) {
        if (openUrl) setLastOpenUrl(openUrl);
        playWeatherLocally();
        return;
      }

      const body = contextUri ? { context_uri: contextUri } : { uris: [trackUri] };
      const playRes = await fetch('/play', { method:'PUT', credentials:'include', headers:{'content-type':'application/json'}, body: JSON.stringify(body) });
      if (!playRes.ok) {
        if (openUrl) setLastOpenUrl(openUrl);
        playWeatherLocally();
      }
    }

    async function getLocationWithFallback() {
      const geoByBrowser = new Promise((resolve, reject) => {
        if (!navigator.geolocation) return reject(new Error('geolocation_unsupported'));
        const tid = setTimeout(() => reject(new Error('geolocation_timeout')), 6000);
        navigator.geolocation.getCurrentPosition(
          pos => { clearTimeout(tid); resolve({
            lat: pos.coords.latitude,
            lon: pos.coords.longitude,
            city: null,
            source: 'browser'
          }); },
          err => { clearTimeout(tid); reject(err); },
          { enableHighAccuracy: false, timeout: 5000, maximumAge: 300000 }
        );
      });

      try {
        const r = await geoByBrowser;
        return r;
      } catch (e) {
        console.warn('[geo] browser failed:', e.message || e);
      }

      try {
        const resp = await fetch('https://ipapi.co/json/');
        if (resp.ok) {
          const j = await resp.json();
          if (j && j.latitude && j.longitude) {
            return { lat: j.latitude, lon: j.longitude, city: j.city || null, source: 'ipapi' };
          }
        } else {
          console.warn('[geo] ipapi status:', resp.status);
        }
      } catch (e) {
        console.warn('[geo] ipapi error:', e);
      }

      console.warn('[geo] fallback to default: Tokyo');
      return { lat: 35.681236, lon: 139.767125, city: 'æ±äº¬(ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)', source: 'default' };
    }

    async function renderUserPlaylists(){
      const grid = document.getElementById('playlists');
      const tracksPanel = document.getElementById('playlist-tracks');
      if (!grid) return;

      grid.innerHTML = `<div style="opacity:.8;">èª­ã¿è¾¼ã¿ä¸­...</div>`;
      tracksPanel.innerHTML = '';

      const logged = await ensureLoggedIn();
      if (!logged) {
        grid.innerHTML = `<div style="opacity:.8;">æœªé€£æºã§ã™ã€‚ã€ŒSpotify é€£æº/æ›´æ–°ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚</div>`;
        return;
      }

      try {
        const data = await api('/playlists');
        const items = data.items || [];
        if (!items.length) {
          grid.innerHTML = `<div style="opacity:.8;">æ­Œå˜ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</div>`;
          return;
        }

        grid.innerHTML = items.map(p => {
          const img = p.image ? `<img src="${p.image}" alt="" style="width:100%;height:180px;object-fit:cover;border-radius:12px;">` : `<div style="width:100%;height:180px;background:#222;border-radius:12px;display:flex;align-items:center;justify-content:center;opacity:.6;">No Image</div>`;
          return `
            <div class="pl-card" data-plid="${p.id}" data-uri="${p.uri}" data-ext="${p.external_url || ''}" style="background:rgba(0,0,0,.25);border:1px solid #222;border-radius:14px;padding:10px;">
              <div class="pl-cover" style="position:relative;cursor:pointer;">
                ${img}
                <button class="play-btn" title="æ’­æ”¾" style="position:absolute;right:8px;bottom:8px;border:none;border-radius:18px;padding:8px 12px;background:#1DB954;color:#fff;cursor:pointer;">â–¶</button>
              </div>
              <div style="margin-top:8px;font-weight:600;line-height:1.3;">${escapeHtml(p.name)}</div>
              <div style="opacity:.8;font-size:12px;margin-top:2px;">${p.tracks_total} æ›² â€¢ by ${escapeHtml(p.owner)}</div>
              <div style="display:flex;gap:8px;margin-top:8px;">
                <button class="open-btn" style="border:1px solid #333;background:transparent;color:#e6eef3;border-radius:8px;padding:6px 10px;cursor:pointer;">Spotifyã§è¦‹ã‚‹</button>
                <button class="tracks-btn" style="border:1px solid #333;background:transparent;color:#e6eef3;border-radius:8px;padding:6px 10px;cursor:pointer;">ãƒªã‚¹ãƒˆè©³ã—ãè¦‹ã‚‹</button>
              </div>
            </div>
          `;
        }).join('');

        grid.querySelectorAll('.pl-card').forEach(card => {
          const id = card.dataset.plid;
          const uri = card.dataset.uri;
          const ext = card.dataset.ext;

          card.querySelector('.pl-cover').addEventListener('click', () => {
            playSpotifyPlaylist({ id, uri, external_url: ext });
          });
          card.querySelector('.play-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            playSpotifyPlaylist({ id, uri, external_url: ext });
          });

          card.querySelector('.open-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            if (ext) window.open(ext, '_blank');
          });

          card.querySelector('.tracks-btn').addEventListener('click', async (e) => {
            e.stopPropagation();
            await renderTracksForPlaylist(id, card, tracksPanel);
          });
        });

      } catch (e) {
        console.error('renderUserPlaylists error', e);
        grid.innerHTML = `<div style="opacity:.8;">æ­Œå˜ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</div>`;
      }
    }

    async function playSpotifyPlaylist(playlist){
      setLastOpenUrl(playlist.external_url || null);

      const logged = await ensureLoggedIn();
      if (!logged) return connectSpotify();

      if (!(await isPremiumUser())) {
        if (playlist.external_url) location.href = playlist.external_url;
        return;
      }

      const ok = await ensureActiveDevice();
      if (!ok) {
        if (playlist.external_url) location.href = playlist.external_url;
        return;
      }

      try {
        const res = await fetch('/play', {
          method:'PUT',
          credentials:'include',
          headers:{'content-type':'application/json'},
          body: JSON.stringify({ context_uri: playlist.uri })
        });
        if(!res.ok && playlist.external_url){
          location.href = playlist.external_url;
        }
      } catch (e) {
        console.error('play playlist error', e);
        if (playlist.external_url) location.href = playlist.external_url;
      }
    }

    async function renderTracksForPlaylist(playlistId, cardEl, panelEl){
      if (!panelEl) return;
      panelEl.innerHTML = `<div style="opacity:.8;">æ›²ç›®èª­ã¿è¾¼ã¿ä¸­...</div>`;
      try{
        const data = await api(`/playlist/${encodeURIComponent(playlistId)}/tracks?limit=100`);
        const items = data.items || [];
        if (!items.length) {
          panelEl.innerHTML = `<div style="opacity:.8;">æ›²ç›®ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
          return;
        }
        panelEl.innerHTML = `
          <h3 style="margin-top:12px;">æ›²ç›®ï¼ˆãƒˆãƒƒãƒ— ${items.length} æ›²ï¼‰</h3>
          <div style="display:grid;grid-template-columns:1fr;gap:10px;margin-top:8px;">
            ${items.map((t,i)=>`
              <div style="display:flex;gap:10px;align-items:center;background:rgba(0,0,0,.25);border:1px solid #222;border-radius:10px;padding:8px;">
                <div style="width:40px;text-align:right;opacity:.7;">${i+1}</div>
                ${t.image ? `<img src="${t.image}" style="width:40px;height:40px;object-fit:cover;border-radius:6px;">` : `<div style="width:40px;height:40px;background:#222;border-radius:6px;"></div>`}
                <div style="flex:1;min-width:0;">
                  <div style="font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${escapeHtml(t.name)}</div>
                  <div style="opacity:.8;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${escapeHtml((t.artists||[]).join(', '))}</div>
                </div>
                <button onclick="openTrackExternally('${t.external_url || ''}')" style="border:1px solid #333;background:transparent;color:#e6eef3;border-radius:8px;padding:6px 10px;cursor:pointer;">å†ç”Ÿ</button>
              </div>
            `).join('')}
          </div>
        `;
      }catch(e){
        console.error('renderTracksForPlaylist error', e);
        panelEl.innerHTML = `<div style="opacity:.8;">æ›²ç›®ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</div>`;
      }
    }

    function openTrackExternally(url){
      if (!url) return;
      window.open(url, '_blank');
    }

    function escapeHtml(s){
      return (s || '').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
    }

  </script>
</body>
</html>
